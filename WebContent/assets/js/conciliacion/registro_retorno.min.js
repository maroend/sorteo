/*
App Sorteo Anáhuac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/

var ultimoFolio='';


function onkeyup_boleto_check(e){
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
    
	var code = (e.which) ? e.which : e.keyCode;
        
	if(code==8)
	{
		//backspace
		return true;
	}
	else if(code>=48 && code<=57)
	{
		return true;
	}
	else if(code==13)
	{
		obtenerTalonario();
		return true;
	}
	else
	{
		//$("#barcodeboleto").val('');
		return false;
	}

}



function obtenerTalonario(){
	
	var folio = $('#barcodeboleto').val(); 
	$("#barcodeboleto").prop('disabled', true);
	ultimoFolio = folio;
	$('#boletostalonario').html('');
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
	
	$.ajax({
	    type: "GET", 
      cache: false, 
	    url: "RegistroVenta",
	    data: "view=getTalonario&folio="+folio,  
	    success: function(msg){
	    	
	    	var res = msg.split("|");    	
	    	
	    	
	    	$("#foliotalon").html(res[0]);
	    	$("#numboletos").html(res[1]);
	    	$("#montoabono").html("$"+res[2]);
	    	
	    	
	    	var url = 'SeguimientoBoletos?idsorteo='+res[3]+'&amp;idboleto='+res[5];
	    	
	    	$("#btnseguimientotal").attr('href',url);

	    if(res[14] == 1){
					
				$('#img_icono_error').show();
				$('#barcodeboleto').val('');	
				$("#barcodeboleto").prop('disabled', false);
				$("#barcodeboleto").focus();
				$("#foliotalon").html('-');
				$("#numboletos").html('-');
				$("#montoabono").html("$0.0");
				$.gritter.add({ title : "RETORNO NO REGISTRADO", text : 'El boleto '+ultimoFolio+' es electr&oacute;nico' });
				return false;
				
			}
	    	
	    	
	    	
			if(checaBoletoVendido(res)==false)
				return;
			
	    	RetornoBoletosVendidos(res[6],res[3],res[5],res[0]);
	    	
	    	//  1|11|600.00|46|300.00|18184|200001|null|null|null|vendido|asignado|insidencia
			//  0  1   2    3   4     5     6      7    8    9
	             
	    }
	});
}

function checaBoletoVendido(res){
	// Si el boleto no esta vendido ...
	
	//alert(res[10]);
	if(res[10].trim()!='V'){
		$('#img_icono_error').show();
		$('#barcodeboleto').val('');	
		$("#barcodeboleto").prop('disabled', false);
		$("#barcodeboleto").focus();
		$("#foliotalon").html('-');
		$("#numboletos").html('-');
		$("#montoabono").html("$0.0");
		$.gritter.add({ title : "RETORNO NO REGISTRADO", text : 'El boleto '+ultimoFolio+' no esta vendido' });
		return false;
	}
	return true;
}




function BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario) {

	var idsorteo = sorteo;
	var talonario = idtalonario;

	$.ajax({
		type : "GET",
		cache : false,
		url : "BoletosSorteo",
		data : "view=BuscarBoletosTalonarios&sorteo=" + idsorteo
				+ "&talonario=" + talonario,
		success : function(msg) {

			$('#boletostalonario').html(msg);

		},
		error : function(msg){
			console.log('BuscarBoletosTalonarios/ajax/error');
		}

	});

}


function RetornoBoletosVendidos(idboleto,sorteo, pk_talonario, idtalonario) {
	
	//alert(idboleto);
	var idboletos = idboleto;
	// var folio = $('#folio').val();
	var operacion = 'RetornoBoletosV';


	$.ajax({
				type : "POST",
				cache : false,
				url : "BoletosSorteo",
				data : {
					idboletos : idboletos,
					operacion : operacion
				/* ,folio: folio */},
				success : function(msg) {

					if (msg.trim() == "") {

						$.gritter.add({
							title : "Correcto",
							text : 'El boleto '+ultimoFolio+' se ha retornado con exito!',
						});
						$('#img_icono_bien').show();
						$('#barcodeboleto').val('');
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();
						
						
						BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario);
						
						
					} else {
						
						$('#img_icono_error').show();
						$('#barcodeboleto').val('');	
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();
						
						
						$('html, body').animate({
							scrollTop : 0
						}, 10);
						$("#alerta").fadeIn();
						$("#alerta").removeClass();
						$("#alerta").addClass("alert alert-error");
						// $("#headAlerta").html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
						$("#bodyAlerta")
								.html(
										"<strong>No te alarmes</strong>!! al parecer no se retorno los boletos, por favor intentalo nuevamente.");
					}

				},
				error : function(msg){
					 $('#barcodeboleto').val('');	
					   $("#barcodeboleto").prop('disabled', false);
					   $("#barcodeboleto").focus();
					
					console.log('RetornoBoletosVendidos/ajax/error');
				}
			});
}


