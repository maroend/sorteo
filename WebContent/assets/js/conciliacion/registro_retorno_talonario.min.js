/*
App Sorteo Anáhuac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/

var ultimoFolio='';


function onkeyup_boleto_check(e){
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
    
	var code = (e.which) ? e.which : e.keyCode;
        
	if(code==8)
	{
		//backspace
		return true;
	}
	else if(code>=48 && code<=57)
	{
		return true;
	}
	else if(code==13)
	{
		obtenerTalonario();
		return true;
	}
	else
	{
		//$("#barcodeboleto").val('');
		return false;
	}

}



function obtenerTalonario(){
	
	var folioStr = $('#barcodeboleto').val(); 
	
	//quita los ceros a la izquierda
	var folio = parseInt(folioStr,10);
	
	$("#barcodeboleto").prop('disabled', true);
	ultimoFolio = folioStr;
	$('#boletostalonario').html('');
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
	
	$.ajax({
	    type: "GET", 
      cache: false, 
	    url: "RegistroVenta",
	    data: "view=obtenerTalonario&folio="+folio,  
	    success: function(msg){	    	
	    	
	    	
	    	var res = msg.split("|");	   	
	   
	    	
	    	$("#foliotalon").html(res[0]);
	    	$("#numboletos").html(res[1]);	    
	    	$("#montoabono").html("$"+res[2]);  
	    	
	    	
	    	
	    	var url = 'SeguimientoTalonarios?idsorteo='+res[3]+'&amp;idtalonario='+res[4];
	    	
	    	$("#btnseguimientotal").attr('href',url);

	    	
			if(checaBoletoVendido(res)==false)
				return;
			
	    	RetornoBoletosVendidos(res[3],res[4],res[0]);	    	
	    	
	    
	             
	    }
	   
	           });
	
	
}
function checaBoletoVendido(res){
	
	
	var retorno = false;
	// Si el boleto esta completamente vendido ...
	if( parseInt(res[5]) == parseInt(res[1]) ){
		return true;
		
	}else{
		
		
				
		    var confirm=window.confirm("El TALONARIO ("+ultimoFolio+") , que desea retornar NO ESTA COMPLETAMENTE VENDIDO, desea marcarlo como vendido completamente?");
		    if (confirm==true) {
		    	
		    	$("#barcodeboleto").prop('disabled', true);		    
		    	$('#boletostalonario').html('');
		    	$('#img_icono_bien').hide();
		    	$('#img_icono_error').hide();
		
			folio = res[4];//folio talonario		    	
			
			
		    	$.ajax({
		    	    type: "GET", 
		          cache: false, 
		    	    url: "RegistroVenta",
		    	    data: "view=VenderTalonarioCompleto&folio="+folio,  
		    	    success: function(msg){
		    	    	
		    	    	
		    	    	//alert(msg);
		    	    	
		    	    	
		    	    	$("#montoabono").html("$"+msg);
		    	
		    	
		    	    	return true;//se vendio el tal completo
		    	    	
		    	    }
		 	   
		           });	    	
		       	
		    	
		   }else{ 		   
			  
		   
		   
		   $('#img_icono_error').show();
			$('#barcodeboleto').val('');	
			$("#barcodeboleto").prop('disabled', false);
			$("#barcodeboleto").focus();
			$("#foliotalon").html('-');
			$("#numboletos").html('-');
			$("#montoabono").html("$0.0");
			
			
			 $.gritter.add({ title : "RETORNO NO REGISTRADO", text : 'El TALONARIO '+ultimoFolio+' no esta totalmente vendido' });
		       
			return false;	   
		   
		   
		   
		   }		
		
		   
		
	}
	
}






function BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario) {

	var idsorteo = sorteo;
	var talonario = idtalonario;

	$.ajax({
		type : "GET",
		cache : false,
		url : "BoletosSorteo",
		data : "view=BuscarBoletosTalonarios&sorteo=" + idsorteo
				+ "&talonario=" + talonario,
		success : function(msg) {

			$('#boletostalonario').html(msg);

		},
		error : function(msg){
			console.log('BuscarBoletosTalonarios/ajax/error');
		}

	});

}


function RetornoBoletosVendidos(sorteo, pk_talonario, idtalonario) {
	
	
	
	var operacion = 'RetornoBoletosVTalonarios';


	$.ajax({
				type : "POST",
				cache : false,
				url : "BoletosSorteo",
				data : {
					idtalonario : idtalonario,
					operacion : operacion
				/* ,folio: folio */},
				success : function(msg) {

					if (msg.trim() == "") {

						$.gritter.add({
							title : "Correcto",
							text : 'El talonario '+ultimoFolio+' se ha retornado con exito!',
						});
						$('#img_icono_bien').show();
						$('#barcodeboleto').val('');
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();
						
						
						BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario);
						
						
					} else {
						
						$('#img_icono_error').show();
						$('#barcodeboleto').val('');	
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();
						
						
						$('html, body').animate({
							scrollTop : 0
						}, 10);
						$("#alerta").fadeIn();
						$("#alerta").removeClass();
						$("#alerta").addClass("alert alert-error");
						// $("#headAlerta").html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
						$("#bodyAlerta")
								.html(
										"<strong>No te alarmes</strong>!! al parecer no se retorno el talonario, por favor intentalo nuevamente.");
					}

				},
				error : function(msg){
					 $('#barcodeboleto').val('');	
					   $("#barcodeboleto").prop('disabled', false);
					   $("#barcodeboleto").focus();
					
					console.log('RetornoBoletosVendidos/ajax/error');
				}
			});
}


