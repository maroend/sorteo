/*
App Sorteo Anáhuac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/

var pag = 1;

var Listar=function(){'use strict';return{init:function(){

	handleListar()

}}}()


$(document).ready(function() {

	$('#alerta').hide();
	/*
	handlebuscarSectoresBuscar(function(){
		handlebuscarNichosSectorBuscar(function(){
			handleListarFechas(function(){
				handleListar();
			});
		});
	});
	*/
	handleListarFechas(function(){
		handleListar();
	});
});


function onkeyup_colfield_check(e){
	var enterKey = 13;
		if (e.which == enterKey){
			pag = 1;
			handleListar()
		}
}

function changeShow(){

	pag=1;
	handleListar()
}

function getPag(page){

	pag = page;
	handleListar()
}



var handleListar = function() {
	var show = $('#data-elements-length').val();
	var search = $('#searchtable').val();

	var idsectorb = $('#idsectorb').val();
	var idnichob = $('#idnichob').val();
	var filtroFecha = btoa($('#filtroFecha').val());

	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border:'null' },
		overlayCSS: {backgroundColor: '#FFF'},
		message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	});
	
	$.ajax({
		type: 'GET',
		url: 'DetalleConciliacion',
		data : 'view=Buscar&pg=' + pag + '&show=' + show + '&search=' + search
				+ '&idsectorb=' + idsectorb + '&idnichob=' + idnichob
				+ '&filtroFecha=' + filtroFecha,
		success: function(msg){
			$('div.block').unblock();
			$('#listresultados').html(msg);
		}
	});
}


// busca sectores al comienzo de cargar la pagina

function handlebuscarSectoresBuscar(f_complete) {

	var usuario = $('#usuario').val();
	var idsectorU = $('#idsectorU').val();

	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border:'null' },
		overlayCSS: {backgroundColor: '#FFF'},
		message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	});

	$.ajax({
		type : 'GET',
		url : 'DetalleConciliacion',
		data : 'view=BuscarSectorInicio&idsectorU=' + idsectorU + '&usuario=' + usuario,
		success : function(msg) {

			$('#idsectorb').html(msg);
			$('div.block').unblock();
			
		},
		complete: function(){
			if (f_complete != null && (typeof f_complete) == 'function')
				f_complete();
		}

	});

}


function handlebuscarNichosSectorBuscar(f_complete) {

	idsector = $('#idsectorb').val();

	if (idsector != '') {

		$.ajax({
			type : 'GET',
			url : 'DetalleConciliacion',//'Colaboradores.do',
			data : 'view=BuscarNichosSectorInicio&idsector=' + idsector,
			success : function(msg) {
				$('#idnichob').html(msg);
			},
			complete: function(){
				if (f_complete != null && (typeof f_complete) == 'function')
					f_complete();
			}
		});

	} else {
		$('#idnichob').html('<option value="">Todos</option>');
		if (f_complete != null && (typeof f_complete) == 'function')
			f_complete();
	}
}


var handleListarFechas = function(f_complete) {
	// TODO handleListarFechas
	var search = $('#searchtable').val();
	var idsectorb = $('#idsectorb').val();
	var idnichob = $('#idnichob').val();

	//if (idsectorb != '') {
		$.ajax({
			type: 'GET',
			url: 'DetalleConciliacion',
			data: 'view=ListarFechas&idsectorb=' + idsectorb + '&idnichob=' + idnichob + '&search=' + search,
			success: function(msg){
				$('#filtroFecha').html(msg);
			},
			complete: function(){
				if (f_complete != null && (typeof f_complete) == 'function')
					f_complete();
			}
		});
		/*
	}
	else {
		$('#filtroFecha').html('<option value="">Todos</option>');
	}
	//*/
}


$('#idsectorb').change(function(e) {
	e.preventDefault();
	handlebuscarNichosSectorBuscar(function(){
		handleListarFechas(function(){
			handleListar();
		});
	});
});

$('#idnichob').change(function(e) {
	e.preventDefault();
	handleListarFechas(function(){
		handleListar();
	});
});

$('#filtroFecha').change(function(e){
	e.preventDefault();
	handleListar();
});


function gup(name){

	var regexS = "[\\?&]"+name+"=([^&#]*)";
	var regex = new RegExp ( regexS );
	var tmpURL = window.location.href;
	var results = regex.exec( tmpURL );
	if( results == null )
		return'';
	else
		return results[1];
}





function Abono(idcolaborador) {
	$('#comision').val('');
	$('#formulario2').parsley().reset();
	$('#aceptarmodalComision').attr('onClick', "javascript:actualizarAbono('"+idcolaborador+"');return false;");
	$('#myModalComision').modal('show');
 }

function actualizarAbono(idcolaborador){


	var abono = $('#abono').val();

	if( $('#formulario2').parsley().validate() ){

		$('div.block').block({
				css: { backgroundColor: 'transparent', color: '#336B86', border:'null' },
				overlayCSS: {backgroundColor: '#FFF'},
				message: '<img src="assets/img/load-search.gif" /><br><h2> Actualizando Estatus..</h2>'
		});

		
		$.ajax({
			type: 'GET',
			url: 'Conciliacion',
			data: 'view=actualizarAbono&idcolaborador='+idcolaborador+'&abono='+abono,
			success: function(msg)
			{
				$('#myModalComision').modal('hide');
				$('div.block').unblock();
				Listar.init();

				if(msg.trim()=='')
				{
					$.gritter.add({title:'ABONO:',text:'Se ha agragado con exito!'});
				}
				else{
					$('html, body').animate({scrollTop:0}, 10);
					$('#alerta').fadeIn();
					$('#alerta').removeClass();
					$('#alerta').addClass('alert alert-error');
					//$('#headAlerta').html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
					$('#bodyAlerta').html('<strong>No te alarmes</strong>!! al parecer no se actualizo, por favor intentalo nuevamente.');


				}
				Listar.init();
			}
		});

	}
	return false;

}


function ExportExcel()
{
	var show = $('#data-elements-length').val();
	var search = $('#searchtable').val();

	var idsectorb = $('#idsectorb').val();
	var idnichob = $('#idnichob').val();
	var filtroFecha = $('#filtroFecha').val();

	if (search != '') {
		pag = 1;
	}

	location.href='DetalleConciliacion?view=ExportExcel&pg='+pag+'&show='+show+'&search='+search+'&idsectorb='+idsectorb+'&idnichob='+idnichob+'&filtroFecha='+filtroFecha;
}

function showHistorial()
{
	var search = $('#searchtable').val();
	var idsectorb = $('#idsectorb').val();
	var idnichob = $('#idnichob').val();
	var opt_sector = $( "#idsectorb option:selected" ).text();
	var opt_nicho = $( "#idnichob option:selected" ).text();
	
	$('#opt_sector').html('<span style="color:' + ((idsectorb == 0)?'DarlBlue':'DarkRed') + '">'+opt_sector+'</span>');
	$('#opt_nicho').html( '<span style="color:' + ((idnichob  == 0)?'DarlBlue':'DarkRed') + '">'+opt_nicho+'</span>');

	$('#ModalConciliaciones').modal('show');
	$('#tableHistorial').html('<tr><td>Cargando conciliaci&oacute;n <img style="width:14pt;" alt="..." src="assets/img/load.gif"></td></tr>');

	$.ajax({
		type: 'GET',
		url: 'DetalleConciliacion',
		data: 'view=ListarFechasModal&search=' + search + '&idsectorb=' + idsectorb + '&idnichob=' + idnichob,
		success: function(msg)
		{
			$('#tableHistorial').html(msg);
		},
		error: function(msg)
		{
			$('#tableHistorial').html("<tr><td>No se ha podido cargar la conciliaci&oacute;n, intentelo nuevamente.</td></tr>");
		}
	});
}

function BorrarConciliacion(filtroFecha, td_id, next_button_id)
{
	var search = $('#searchtable').val();
	var idsectorb = $('#idsectorb').val();
	var idnichob = $('#idnichob').val();
	
	var yes = confirm("Confirmar que desea borrar este proceso de conciliacion");
	if(yes)
	{
		$('#'+td_id).html('<img style="width:14pt;" alt="..." src="assets/img/load.gif">');
		$.ajax({
			type: 'GET',
			url: 'DetalleConciliacion',
			data: 'view=Rollback&search=' + search + '&idsectorb=' + idsectorb + '&idnichob=' + idnichob + '&filtroFecha=' + filtroFecha,
			success: function(msg)
			{
				$('#'+td_id).html(msg);
				handleListar();
				var btn = $('#'+next_button_id);
				if (btn != null){
					btn.removeClass('btn-white disabled');
					btn.addClass('btn-warning');
				}
			}
		});
	}
}


