/*
App Sorteo Anáhuac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/

$(function(){		
	$('#alerta').hide();	
	$(window).load(function() {		
		$("#formato").focus();
	});
});//End function jquery



var ultimoFolio='';


function onkeyup_boleto_check(e){
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
    
	var code = (e.which) ? e.which : e.keyCode;
        
	if(code==8)
	{
		//backspace
		return true;
	}
	else if(code>=48 && code<=57)
	{
		return true;
	}
	else if(code==13)
	{
		obtenerTalonario();
		return true;
	}
	else
	{
		//$("#barcodeboleto").val('');
		return false;
	}

}



function obtenerTalonario(){
	
	
	
	var folioStr = $('#barcodeboleto').val(); 
	var formato = $('#formato').val();
	
	
	if(folioStr == ""){
		$("#barcodeboleto").css("border","red solid 2px");
		return;	
	}else
		$("#barcodeboleto").css("border","#CCD0D4 solid 2px");	
	
	
	if(formato == ""){
		$("#formato").css("border","red solid 2px");
		return;	
	}else
		$("#formato").css("border","#CCD0D4 solid 2px");
	
	//quita los ceros a la izquierda
	var folio = parseInt(folioStr,10);	
	
	
	$("#formato").prop('disabled', true);
	$("#barcodeboleto").prop('disabled', true);
	ultimoFolio = folioStr;
	$('#boletostalonario').html('');
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
	$('#img_icono_ejecutando').show();
	
	$.ajax({
	    type: "GET", 
      cache: false, 
	    url: "DevolverTalonarios",
	    data: "view=obtenerTalonarioFC5&folio="+folio,  
	    success: function(msg){	    	
	    	
	    	var res = msg.split("|");   
	    	
	    	
	    	$("#foliotalon").html(res[4]);
	    //	$("#foliotalon").html(res[0]);//PK1
	    	$("#numboletos").html(res[1]);//NUMBOLETOS	    
	    	$("#montoabono").html("$"+res[2]);//ABONO  tal  	    	
	    		
	    	    	
			if(TalCompletamenteNOVendido(res)==false)
			return;			
			
			//PK_SECTOR	
			var idsector;
			if(res[6].trim() == "null" || res[6].trim() == ""){ idsector = 0;}
			else{ idsector = res[6].trim();}			
			
			//PK_NICHO
			var idnicho; 
			if(res[7].trim() == "null" || res[7].trim() == ""){ idnicho = 0; }
			else{ idnicho = res[7].trim(); }			
			
			
			var idcolaborador;
			if(res[8].trim() == "null" || res[8].trim() == ""){ idcolaborador = 0;}
			else{ idcolaborador = res[8].trim();}
			
						
			DevolucionBoletosFC5(res[0],folio,formato,idsector,idnicho,idcolaborador);	  
			
	    	//RetornoBoletosVendidos(res[3],res[4],res[0]);	     	
	    
	             
	    }	   
	           });	
	
	
}


function TalCompletamenteNOVendido(res){
	
	       //BNOVENDIDOS == NUMBOLETOS : Si el boleto esta completamente NO vendido ...
	if( parseInt(res[5]) == parseInt(res[1]) ){ 		
		// $.gritter.add({title:"Talonario Devuelto FC5:",text:"El Talonario esta TOTALMENTE NO vendido!"});
		return true;		
	}else{
		 $.gritter.add({title:"Talonario Devuelto FC5:",text:"El Talonario no esta TOTALMENTE NO vendido!"});
		 $('#img_icono_error').show();
		    $("#formato").prop('disabled', false);   
			$('#barcodeboleto').val('');	
			$("#barcodeboleto").prop('disabled', false);
			$("#barcodeboleto").focus();
			$('#img_icono_ejecutando').hide();
		return false;			
	}	
}



function DevolucionBoletosFC5(idtalonario,folio,formato,idsector,idnicho,idcolaborador) {		
	
	
	var operacion = 'DevolucionBoletosFC5';	

	
	$.ajax({
				type : "POST",
				cache : false,
				url : "DevolverTalonarios",
				data : {
					idtalonario: idtalonario,
					operacion: operacion,
				    folio: folio, 
				    idsector: idsector,
				    idnicho: idnicho,
				    idcolaborador: idcolaborador,
				    formato: formato
				    },
				success : function(msg) {					
					

					if (msg.trim() == "") {

						$.gritter.add({
							title : "Correcto",
							text : 'El talonario '+ultimoFolio+' se ha Devuelto con exito!',
						});
						$('#img_icono_ejecutando').hide();
						$("#formato").prop('disabled', false);   
						$('#img_icono_bien').show();
						$('#barcodeboleto').val('');
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();						
						
						//BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario);						
						
					} else {
						
						$('#img_icono_ejecutando').hide();
						$("#formato").prop('disabled', false);   
						$('#img_icono_error').show();
						$('#barcodeboleto').val('');	
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();
						
						
						$('html, body').animate({
							scrollTop : 0
						}, 10);
						$("#alerta").fadeIn();
						$("#alerta").removeClass();
						$("#alerta").addClass("alert alert-error");
						// $("#headAlerta").html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
						$("#bodyAlerta")
								.html(
										"<strong>No te alarmes</strong>!! al parecer no se Devolvio el talonario, por favor intentalo nuevamente.");
					}

				},
				error : function(msg){
					
					$('#img_icono_ejecutando').hide();
					$("#formato").prop('disabled', false);   
					$('#barcodeboleto').val('');	
					$("#barcodeboleto").prop('disabled', false);
					$("#barcodeboleto").focus();
					
					console.log('DevolucionBoletosFC5/ajax/error');
				}
			});
}



function BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario) {

	var idsorteo = sorteo;
	var talonario = idtalonario;

	$.ajax({
		type : "GET",
		cache : false,
		url : "BoletosSorteo",
		data : "view=BuscarBoletosTalonarios&sorteo=" + idsorteo
				+ "&talonario=" + talonario,
		success : function(msg) {

			$('#boletostalonario').html(msg);

		},
		error : function(msg){
			console.log('BuscarBoletosTalonarios/ajax/error');
		}

	});

}


function RetornoBoletosVendidos(sorteo, pk_talonario, idtalonario) {	
	
	
	var operacion = 'RetornoBoletosVTalonarios';


	$.ajax({
				type : "POST",
				cache : false,
				url : "BoletosSorteo",
				data : {
					idtalonario : idtalonario,
					operacion : operacion
				/* ,folio: folio */},
				success : function(msg) {

					if (msg.trim() == "") {

						$.gritter.add({
							title : "Correcto",
							text : 'El talonario '+ultimoFolio+' se ha retornado con exito!',
						});
						
						$('#img_icono_ejecutando').hide();
						$('#img_icono_bien').show();
						$('#barcodeboleto').val('');
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();
						
						
						BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario);
						
						
					} else {						
						
						$('#img_icono_error').show();
						$('#barcodeboleto').val('');	
						$("#barcodeboleto").prop('disabled', false);
						$("#barcodeboleto").focus();
						
						
						$('html, body').animate({
							scrollTop : 0
						}, 10);
						$("#alerta").fadeIn();
						$("#alerta").removeClass();
						$("#alerta").addClass("alert alert-error");
						// $("#headAlerta").html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
						$("#bodyAlerta")
								.html(
										"<strong>No te alarmes</strong>!! al parecer no se retorno el talonario, por favor intentalo nuevamente.");
					}

				},
				error : function(msg){
					 $('#barcodeboleto').val('');	
					   $("#barcodeboleto").prop('disabled', false);
					   $("#barcodeboleto").focus();
					
					console.log('RetornoBoletosVendidos/ajax/error');
				}
			});
}


