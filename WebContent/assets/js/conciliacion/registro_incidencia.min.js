/*   
App Sorteo Anáhuac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/

var ultimoFolio='';

function initialize(){
	limpia();
}

function limpia()
{
	$('#incidencia').val('N');
	$('#formato_fc8').val('');
	$('#folio_acta_mp').val('');
	$('#detalles_incidencia').val('');
	
	$('#incidencia').prop('disabled',true);
	$('#formato_fc8').prop('disabled',true);
	$('#folio_acta_mp').prop('disabled',true);
	$('#detalles_incidencia').prop('disabled',true);
	
	$('#btnRegistrar').addClass('disabled');
	
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
	$('#barcodeboleto').val('');
	$("#barcodeboleto").prop('disabled', false);
	$('#barcodeboleto').focus();
	
	
	//boton	
	//$("#btnRegistrar").prop('disabled', true);
	//$("#btnRegistrar").attr('disabled', 'disabled');
	
	
}

function onkeyup_boleto_check(e)
{
	var code = (e.which) ? e.which : e.keyCode;
	
	if(code==8)
	{
		//backspace
		return true;
	}
	else if(code>=48 && code<=57)
	{
		return true;
	}
	else if(code==13)
	{
		obtenerTalonario();
		return false;
	}
	else
	{
		return false;
	}
}

function input_boleto_onkeyup(event)
{
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
}


function checaSectorNichoYColaborador(pksector,pknicho,pkcolaborador)
{
	if(pksector==null || pksector=='null'){
		//$('#barcodeboleto').val('');
		$("#barcodeboleto").prop('disabled', false);
		$("#barcodeboleto").focus();
		$('#img_icono_error').show();
		$.gritter.add({ title : "Atenci&oacute;n", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no est&aacute; asignado a un sector' });
		return false;
	}
	if(pknicho==null || pknicho=='null'){
		//$('#barcodeboleto').val('');
		$("#barcodeboleto").prop('disabled', false);
		$("#barcodeboleto").focus();
		$('#img_icono_error').show();
		$.gritter.add({ title : "Atenci&oacute;n", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no est&aacute; asignado a un nicho' });
		return false;
	}
	if(pkcolaborador==null || pkcolaborador=='null'){
		//$('#barcodeboleto').val('');
		$("#barcodeboleto").prop('disabled', false);
		$("#barcodeboleto").focus();
		$('#img_icono_error').show();
		$.gritter.add({ title : "Atenci&oacute;n", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no est&aacute; asignado a un colaborador' });
		return false;
	}
	return true;
}

function validaTexto(texto){
	if(texto==null)
		return false;
	if (0<=texto.indexOf('&') || 0<=texto.indexOf('=') || 0<=texto.indexOf('?') ||
		0<=texto.indexOf('/') || 0<=texto.indexOf('%') || 0<=texto.indexOf('\\'))
		return false;
	return true;
}

function validaCampo(texto, nombreCampo, vacio){
	if(vacio==false && texto==''){
		$.gritter.add({ title : "Atenci&oacute;n", text : 'El campo \''+nombreCampo+'\' no puede ir vac&iacute;o' });
		return false;
	}
	if (validaTexto(texto, vacio))
		return true;
	else{
		$.gritter.add({ title : "Atenci&oacute;n", text : 'El campo \''+nombreCampo+'\' no admite los simbolos:  &, =, ?, /,\\,% ' });
		return false;
	}
}

function incidencia_onclick(){
	var incidencia = $('#incidencia').val();
	if(incidencia == 'N'){
		$('#formato_fc8').prop('disabled',true);
		$('#folio_acta_mp').prop('disabled',true);
		$('#detalles_incidencia').prop('disabled',true);
		//$('#btnRegistrar').addClass('disabled');
	}
	else{
		$('#formato_fc8').prop('disabled',false);
		$('#folio_acta_mp').prop('disabled',false);
		$('#detalles_incidencia').prop('disabled',false);
		//$('#btnRegistrar').removeClass('disabled');
	}
}

function BuscarIncidenciaBoleto(idsorteo, boleto, talonario) {

	var idsorteo = idsorteo;
	var boleto = boleto;
	var talonario = talonario;

	$.ajax({
		type : "GET",
		cache : false,
		url : "BoletosSorteo",
		data : "view=GetIncidenciaBoleto&sorteo=" + idsorteo + "&boleto=" + boleto + "&talonario=" + talonario,
		success : function(msg) {

			if (msg.trim() == "NULL") {

				$('#incidencia').val('N');
				$('#formato_fc8').val('');
				$('#folio_acta_mp').val('');
				$('#detalles_incidencia').val('');
				
				$.gritter.add({ title : "Atenci&oacute;n", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no tiene incidencia' });
				
				$('#incidencia').prop('disabled',false);
				incidencia_onclick();
				$("#barcodeboleto").prop('disabled', true);
				//$('#btnRegistrar').removeClass('disabled');
				
			}
			else
			{
				var res = msg.split("|");
				var incidencia = "";				
				
				$('#incidencia').prop('disabled',false);
				$('#incidencia').val(res[2].trim());
				$('#formato_fc8').val(res[1]);
				$('#folio_acta_mp').val(res[3]);
				$('#detalles_incidencia').val(res[4]);
				incidencia_onclick();

				$("#barcodeboleto").prop('disabled', true);
			
			}
			
			//$("#btnRegistrar").prop('disabled', false);
			//$("#btnRegistrar").attr('disabled', 'disabled');
			// $('#btnRegistrar').removeAttr("disabled")
			
			$('#btnRegistrar').removeClass("disabled");
			
		},
		error : function(msg){
			console.log('BuscarIncidenciaBoleto/ajax/error');
		}
	});

}

function RegistrarIncidenciaBoleto() {

	var abono = $('#pkabono').val();
	var costo = $('#pkcosto').val();

	var deleteincicencia = false;

	var operacion = "InsertIncidencia";
	var incidencia = $('#incidencia').val();

	if (incidencia.trim() == "N") {
		operacion = "EliminarIncidencia";

		if (confirm("Desea eliminar la incidencia?")) {
			deleteincicencia = true;
		}
	}	
	  

	var formato_fc8 = $('#formato_fc8').val();
	var folio_acta_mp = $('#folio_acta_mp').val();
	var detalles_incidencia = $('#detalles_incidencia').val();

	
	//$("#barcodeboleto").prop('disabled', false);
	//obtenerTalonario();	
		
	
	
	
	if (  (deleteincicencia == false && incidencia.trim() != "N") ||(deleteincicencia == true  && incidencia.trim() == "N") )
	{
		$.ajax({
			type : "POST",
			cache : false,
			url : "BoletosSorteo",
			data : {
				operacion : operacion,
				sorteo : _boleto.pksorteo,
				pksector : _boleto.pksector,
				pknicho : _boleto.pknicho,
				pkcolaborador : _boleto.pkcolaborador,
				talonario : _boleto.talonario,
				pktalonario: _boleto.pktalonario,
				pkboleto : _boleto.pkboleto,
				boleto : _boleto.boleto,
				costo : _boleto.costo,
				abono : _boleto.abono,
				
				incidencia : incidencia,
				formatofc8 : formato_fc8,
				folioactamp : folio_acta_mp,
				detallesincidencia : detalles_incidencia,
			},
			success : function(msg)
			{
				
				$('#img_icono_bien').show();
				$.gritter.add({ title : "Correcto", text : 'Se ha registrado una incidencia para el boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> ' });
				$("#barcodeboleto").prop('disabled', false);
				$('#barcodeboleto').focus();
				$('#btnRegistrar').addClass('disabled');
			},
			error : function(msg){
				console.log('RegistrarIncidenciaBoleto/ajax/error');
			}
		});
	}

}
/*
function InsertarComprador(){
//  (idsorteo,boleto,talonario,costo,pktalonario,pkboleto,pksector,pknicho,pkcolaborador) {
	
	if($('#imunicipio').val()==null){
		$.gritter.add({ title : "Atenci&oacute;n", text : 'El campo \'Municipio o Delegaci&oacute;n\' no puede ir vac&iacute;o ' });
		return;
	}
	var comprador={
		nombre : ($('#inombre').val()).trim()
		, apellidos : ($('#iapellidos').val()).trim()
		, telefonofijo : ($('#itelefonofijo').val()).trim()
		, telefonomovil : ($('#itelefonomovil').val()).trim()
		, correo : ($('#icorreo').val()).trim()
		, calle : ($('#icalle').val()).trim()
		, numero : ($('#inumero').val()).trim()
		, colonia : ($('#icolonia').val()).trim()
		, estado : ($('#iestado').find('option:selected').text()).trim()
		, municipio : ($('#imunicipio').find('option:selected').text()).trim()
	};
	
	if (!validaCampo(comprador.nombre,'Nombre',false) ||
		!validaCampo(comprador.apellidos,'Apellidos',false) ||
		!validaCampo(comprador.telefonofijo,'Telefono Fijo',true) ||
		!validaCampo(comprador.telefonomovil,'Telefono Movil',true) ||
		!validaCampo(comprador.correo,'Correo Electrónico',true) ||
		!validaCampo(comprador.calle,'Calle',false) ||
		!validaCampo(comprador.numero,'Numero',false) ||
		!validaCampo(comprador.colonia,'Colonia',false) ||
		!validaCampo(comprador.estado,'Estado',false) ||
		!validaCampo(comprador.municipio,'Municipio o Delegaci&oacute;n',false)
		)
		return;
	
	$.ajax({
		type : "POST",
		cache : false,
		url : "BoletosSorteo",
		data : {
			operacion : 'InsertComprador',
			extra: 'SoloComprador',
			
			// datos del BOLETO
			boleto : _boleto.boleto,
			pkboleto : _boleto.pkboleto,
			talonario : _boleto.talonario,
			pktalonario : _boleto.pktalonario,
			sorteo : _boleto.pksorteo,
			pksector : _boleto.pksector,
			pknicho : _boleto.pknicho,
			pkcolaborador : _boleto.pkcolaborador,
			costo : _boleto.costo,
			abono : _boleto.abono,
			
			// datos del COMPRADOR
			nombre : comprador.nombre,
			apellidos : comprador.apellidos,
			telefonofijo : comprador.telefonofijo,
			telefonomovil : comprador.telefonomovil,
			correo : comprador.correo,
			calle : comprador.calle,
			numero : comprador.numero,
			colonia : comprador.colonia,
			estado : comprador.estado,
			municipio : comprador.municipio,
		},
		success : function(msg)
		{
			$('#barcodeboleto').val('');	
			$("#barcodeboleto").prop('disabled', false);
			$("#barcodeboleto").focus();
			$.gritter.add({
				title : "Correcto",
				text : 'El comprador se ha registrado con exito!',
			});
			limpia();
			//console.log('msg:'+msg);
		},
		error : function(msg){
			limpia();
			//console.log('InsertarVentaComprador/ 1 /ajax/error');
		}
	});
}
//*/


var _boleto=null;
function obtenerTalonario(){
	
	var folio = $('#barcodeboleto').val().trim();
	if (folio==''){
		$.gritter.add({ title : "ATENCION", text : 'Por favor escriba el folio del boleto a buscar' });
		return;
	}
	$("#barcodeboleto").prop('disabled', true);
	ultimoFolio = folio;
	$.ajax({
		type: "GET",
		cache: false, 
		url: "RegistroVenta",  
		data: "view=getTalonario&folio="+folio,  
		success: function(msg){

			if(msg==null || msg.trim()=='null'){
				
				$('#img_icono_error').show();
				$("#barcodeboleto").prop('disabled', false);
				$.gritter.add({ title : "Atenci&oacute;n", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no existe' });
				$("#barcodeboleto").focus();
				return;
			}
			
			
			
			var res = msg.split("|");
			
			_boleto={
				boleto: ultimoFolio,
				talonario: res[0],
				costo: res[4],
				abono: res[13],
				
				pkboleto: res[6],
				pktalonario: res[5],
				pksorteo: res[3],
				pksector: res[7],
				pknicho: res[8],
				pkcolaborador: res[9],
				
				vendido: res[10],
				asignado: res[11],
				incidencia: res[12],
			};
			
			
			if(checaSectorNichoYColaborador(_boleto.pksector, _boleto.pknicho, _boleto.pkcolaborador)==false){
				return;
			}
			
			BuscarIncidenciaBoleto(_boleto.pksorteo, _boleto.boleto, _boleto.talonario);
			
		},
		error : function(msg){
			//console.log('getTalonario/ajax/error');
		},
		statusCode :{
			302: function() {
				alert('3c3');
			}
	    }
	});
	
}

//-------------------------------------------

function cancelar(){
	limpia();
}


