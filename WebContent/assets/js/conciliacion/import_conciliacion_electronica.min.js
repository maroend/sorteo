
var numpremio=0;
var global = 'false';
var elem = document.querySelector('.js-switch');
var init = new Switchery(elem);
var handleBootstrapWizards=function(){"use strict";$("#wizard").bwizard()};

var globarow = 0;
var globarowsarray = [];

var FormWizard=function(){"use strict";return{init:function(){
	handleBootstrapWizards();
}}}()


$(function(){
	
	 $('previous').attr('aria-disabled',true);  
	
});//End function jquery




$("#wizard").bwizard({validating:function(e,t){

//	<input type="text" name="numero_premio_id" id="numero_premio_id" value="#NUM_PREMIO#" placeholder="" class="form-control" data-parsley-group="wizard-step-1" required />
	
	if(t.index==0){
		
		
		if(false===$('form[name="form-wizard"]').parsley().validate("wizard-step-2"))
			return false

		handlecontrollersave();
	}
	
}});


	
function processFile(fileName){
	
	globarow = 0;
	$('#processfile').html('');
 	$('#imgload').show();
 	$('#logtable').hide();
	
 	$.ajax({ 
 	    type: 'GET',
 	    url: 'ImportConciliacionElectronica',
 	    data: 'view=LoadExcelFile&fileName='+fileName,
 	    success: function(response){
 	    	
 	    	$('#imgload').hide();
 	    	$('#logtable').show();
 	    	
 	    	globarowsarray = [];
 	    	var cadena = response.trim();
 	    	 
 	    	
 	    	globarowsarray = cadena.split('#|#');
 	    	
 	    	var arraytotales = globarowsarray[globarowsarray.length-1].split(',');
 	    	
 	    	$('#numregistrados').html(arraytotales[0]);
 	    	$('#numwarnings').html(arraytotales[1]);
 	    	$('#numerrores').html(arraytotales[2]);
 	    	
 	    	closeTimer();
 	    	 for (var i = 0; i < globarowsarray.length-1; i++) {
 	    		
 	    		 setTimeout(function(){
 	                addElement();
 	            }, 10 * i);
 	        
 	    	 }
 	    
 	    },error: function(msg) {
 	    	closeTimer();
			$('#imgload').html('<h2>Se ha producido un error al intentar leer el archivo</h2>');
			$('#logtable').show();
 	    	$('#logtable').html('<p>Asegurese de que el archivo tenga el formato adecuado (.xls)</p><p><a class="btn btn-primary m-r-5" href="ImportConciliacionElectronica">Regresar</a></p>');
		}
 	});
	
}



function addElement(){
	$('#processfile').append(globarowsarray[globarow]);
	globarow++;
}

var handlecontrollersave = function(){
	
	uploadFile(processFile);
}

function uploadFile(runOnSuccess){
	
	var file_data = $('#inputfileconciliacion').prop('files')[0]; 
	var form_data = new FormData();
	form_data.append('file', file_data);

	$.ajax({
		url: 'ImportConciliacionElectronica',
		 dataType: 'text',  // what to expect back from the PHP script, if anything
         cache: false,
         contentType: false,
         processData: false,
         data: form_data,
         type: 'post',
         success: function(response){
        	 processFile(response);
         },
		 error: function(msg){
			 closeTimer();
		 }
	});

	prepareTimer('div_porcentaje_id', 'progressbar_loading');
	resetTimer();
}


/*
// ___________________________________________________________________________
var timerProgressBar=null;
function prepareTimer(){
	$('#div_porcentaje_id').html("0 %");
	$('#progressbar_loading').val('0');
}
function resetTimer(){
	closeTimer();
	timerProgressBar = setInterval(timerProgressBar_Tick, 2000);
}
function closeTimer(){
	if(timerProgressBar!=null){
		clearTimeout(timerProgressBar);
		timerProgressBar=null;
	}
}
function timerProgressBar_Tick(){
	
	closeTimer();
	$.ajax({
 	    type: 'GET',
 	    url: 'ImportConciliacionElectronica',
 	    data: 'view=ProgressBar',
		complete: function(msg){
		},
 	    success: function(msg)
		{
			if(msg != null && msg.length<5){
				$('#div_porcentaje_id').html(msg+" %");
				console.log('      porcentaje:'+msg);
				$('#progressbar_loading').val(msg);
				
			}
			resetTimer();
		}
	});
}
// ___________________________________________________________________________

*/
