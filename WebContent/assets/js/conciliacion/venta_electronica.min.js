/*   
App Sorteo Anáhuac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/


var Listar = function () {
	"use strict"; return {
		init: function () {

		}
	}
}()


$(document).ready(function () {

	$('#alerta').hide();
	$('#div_ventafc4_id').hide();
	$('#div_ventafc4_msg_id').hide();
	$('#div_completar_id').hide();
	$('#div_completar_msg_id').hide();
	$('#div_refolear_id').hide();
	$('#div_refolear_msg_id').hide();
});



var VentaFC4 = function() {
	if (confirm('Confirmar que desea validar la venta y retorno de boletos electronicos. Este proceso puede tardar varios minutos.'))
	{
		$('#div_ventafc4_id').show();
		$('#div_ventafc4_msg_id').hide();
		$('#img_gif_working').show();
		prepareTimer('div_porcentaje_id_2', 'progressbar_loading_2');

		limpiarVentaFC4(function(msg){
			finishTimer();
			if(msg.trim()=="ok")
				registrarVentaFC4();
			else{
				alert('Ocurrió un error en el proceso de reiniciar la venta de boletos electronicos.');
				$('#img_gif_working').hide();
			}
		});
	}
}

var limpiarVentaFC4 = function(f_sucess)
{
	var idsorteo = $('#id_sorteo').val();
	var b64 = btoa(
			"LIMPIAR:"
			+ ";idsorteo:" + idsorteo
			);
	$.ajax({
		type: "POST",
		url: "VentaElectronica",
		data: { q: b64 },
		success: f_sucess,
		error: function (msg) {
			closeTimer();
			alert('ERROR: Proceso interrumpido');
			$('#div_ventafc4_id').hide();
			$('#div_ventafc4_msg_id').hide();
			$('#img_gif_working').hide();
		}
	});
	prepareTimer('div_porcentaje_id', 'progressbar_loading');
	resetTimer();
}

var registrarVentaFC4 = function() {
	$('#img_gif_working').show();
	var idsorteo = $('#id_sorteo').val();
	var b64 = btoa(
			"REGISTRAR:"
			+ ";idsorteo:" + idsorteo
			);
	
	$.ajax({
		type: "POST",
		url: "VentaElectronica",
		data: { q: b64 },
		success: function (msg) {
			finishTimer();
			
			$('#div_ventafc4_id').hide();
			$('#div_ventafc4_msg_id').show();
			$('#div_ventafc4_msg_id').html('');
			$('#img_gif_working').hide();
			
			var data = jQuery.parseJSON(msg);
			
			if (data.result == 'ok') {
				$.gritter.add({
					title : 'Correcto',
					text : 'Validaci&oacute;n completa de boletos electr&oacute;nicos',
				});
				$('#div_ventafc4_msg_id').html(
					'Boletos electr&oacute;nicos: <br/>'
					+ '<strong>' + data.count_max + "</strong> total <br/>"
					+ '<strong>' + data.count_venta + '</strong> vendidos <br/>'
					+ '<strong>' + data.count_fc4 + "</strong> FC4 <br/>"
					//+ '<strong>' + data.count_error + "</strong> errores <br/>"
				);
			}
			else
				alert('ERROR: Proceso interrumpido');
		},
		error: function (msg) {
			closeTimer();
			alert('ERROR: Proceso interrumpido');
			$('#div_ventafc4_id').hide();
			$('#div_ventafc4_msg_id').show();
			$('#img_gif_working').hide();
		}
	});
	prepareTimer('div_porcentaje_id_2', 'progressbar_loading_2');
	resetTimer();
}


var completarCompradoresModal = function() {
	$('#modalCompletarCompradores').modal('show');
	$('#divNichos_id').html('Buscando nichos ...');
	var idsorteo = $('#id_sorteo').val();
	$.ajax({
		type: "GET",
		cache: false,
		url: "VentaElectronica",
		data: { view: "makeNichosHTML", idsorteo: idsorteo },
		success: function(msg)
		{
			$('#divNichos_id').html(msg);
		},
		error : function(data) { }
	});
}

//var arrayCheckNichos = [[false,0],[false,0]];
var arrayCheckNichos = [
	{"checked":false,"id":"0001"},
	{"checked":false,"id":"0002"}
];

var marcarNicho = function (index) {
	if (arrayCheckNichos[index].checked == false)
		arrayCheckNichos[index].checked = true;
	else
		arrayCheckNichos[index].checked = false;
	
	checkButton(index, arrayCheckNichos[index].checked);
}

function checkButton(index, check)
{
	if (check == true) {
		$('#icon_nicho_' + index).removeClass('fa-square-o');
		$('#icon_nicho_' + index).addClass('fa-check-square-o');
	} else {
		$('#icon_nicho_' + index).removeClass('fa-check-square-o');
		$('#icon_nicho_' + index).addClass('fa-square-o');
	}
}

var btnAceptar = function() {
	var arrayChecked = [];
	for(var i=0; i<arrayCheckNichos.length; i++)
		if (arrayCheckNichos[i].checked == true)
			arrayChecked.push(arrayCheckNichos[i].id);
	$('#modalCompletarCompradores').modal('hide');
	completarCompradores(arrayChecked);
}

var completarCompradores = function(arrayChecked) {
	$('#div_completar_id').show();
	$('#div_completar_msg_id').show();
	$('#div_completar_msg_id').html('Nicho(s): ' + arrayChecked.join());
	$('#img_gif_working').show();
	
	var idsorteo = $('#id_sorteo').val();
	var b64 = btoa(
			"COMPLETAR_COMPRADORES:"
			+ ";idsorteo:" + idsorteo
			+ ";nichos:" + arrayChecked.join()
			);
	$.ajax({
		type: "POST",
		url: "VentaElectronica",
		data: { q: b64 },
		nichos: arrayChecked.join(),
		success: function (msg) {
			finishTimer();
			
			$('#div_completar_id').hide();
			$('#div_completar_msg_id').show();
			$('#img_gif_working').hide();
			var data = jQuery.parseJSON(msg);
			
			if (data.result == 'ok') {
				//$('#div_completar_msg_id').html('<strong>' + arr[1] + '</strong> boletos electr&oacute;nicos vendidos y <strong>' + arr[2] + "</strong> FC4.");
				$('#div_completar_msg_id').html(
						'Nicho(s): ' + this.nichos + '<br/>'
						+ '<strong>' + data.count_talonarios + '</strong> talonarios revisados <br/>'
						+ '<strong>' + data.count_process + '</strong> compradores faltantes <br/>'
						+ '<strong>' + data.count_success + '</strong> compradores registrados <br/>'
						//+ '<strong>' + data.count_error + "</strong> errores <br/>"
				);
				/*
				$.gritter.add({
					title : 'Atenci&oacute;n',
					text : 'La validacion de compradores ha terminado',
				});
				*/
			}
		},
		error: function (msg) {
			closeTimer();
			alert('ERROR: Proceso interrumpido');
			$('#div_completar_id').hide();
			$('#div_completar_msg_id').hide();
			$('#img_gif_working').hide();
		}
	});
	prepareTimer('div_porcentaje_id_3', 'progressbar_loading_3');
	resetTimer();
}

function validarFoliosDigitales(){
	$('#div_refolear_id').show();
	$('#img_gif_working').show();
	var idsorteo = $('#id_sorteo').val();
	var b64 = btoa(
			"REFOLEAR:"
			+ ";idsorteo:" + idsorteo
			);
	
	$.ajax({
		type: "POST",
		url: "VentaElectronica",
		data: { q: b64 },
		success: function (msg) {
			finishTimer();
			
			$('#div_refolear_id').hide();
			$('#div_refolear_msg_id').show();
			$('#div_refolear_msg_id').html('');
			$('#img_gif_working').hide();
			
			var data = jQuery.parseJSON(msg);
			
			if (data.result == 'ok')
			{
				if (data.count_process == data.count_max)
				{
					$.gritter.add({
						title : 'Correcto',
						text : 'Los folios digitales ahora son conecutivos !',
					});
				}
				else {
					$.gritter.add({
						title : 'Atenci&oacute;n',
						text : 'No se completo la validaron de folios digitales',
					});
				}
				$('#div_refolear_msg_id').html(
						'Folios digitales: <br/>'
						+ '<strong>' + data.count_max + "</strong> total <br/>"
						+ '<strong>' + data.count_process + '</strong> validados <br/>'
					);
			}
			else
				alert('ERROR: Proceso interrumpido');
		},
		error: function (msg) {
			closeTimer();
			alert('ERROR: Proceso interrumpido');
			$('#div_refolear_id').hide();
			$('#div_refolear_msg_id').show();
			$('#img_gif_working').hide();
		}
	});
	prepareTimer('div_porcentaje_id_4', 'progressbar_loading_4');
	resetTimer();
}

