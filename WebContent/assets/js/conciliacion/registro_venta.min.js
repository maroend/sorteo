/*   
App Sorteo AnÃ¡huac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/

var ultimoFolio='';

function initialize(){
	limpia();
}

function onkeyup_boleto_check(e)
{
	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
	var code = (e.which) ? e.which : e.keyCode;
	
	if(code==8)
	{
		//backspace
		return true;
	}
	else if(code>=48 && code<=57)
	{
		return true;
	}
	else if(code==13)
	{
		obtenerTalonario();
		return true;
	}
	else
	{
		//$("#barcodeboleto").val('');
		return false;
	}
}



function limpia()
{
	$('#foliotalon').html('-');
	$('#numboletos').html('-');
	$('#montoabono').html('$');
	$('#boletostalonario').html('');

	$('#img_icono_bien').hide();
	$('#img_icono_error').hide();
	$("#barcodeboleto").focus();
}

function checaSectorNichoYColaborador(pksector,pknicho,pkcolaborador){
	
	if(pksector==null || pksector=='null'){
		$('#barcodeboleto').val('');	
		$("#barcodeboleto").prop('disabled', false);
		$("#barcodeboleto").focus();
		$('#img_icono_error').show();
		$.gritter.add({ title : "VENTA NO REGISTRADA", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no est&aacute; asignado a un sector' });
		return false;
	}
	if(pknicho==null || pknicho=='null'){
		$('#barcodeboleto').val('');	
		$("#barcodeboleto").prop('disabled', false);
		$("#barcodeboleto").focus();
		$('#img_icono_error').show();
		$.gritter.add({ title : "VENTA NO REGISTRADA", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no est&aacute; asignado a un nicho' });
		return false;
	}
	if(pkcolaborador==null || pkcolaborador=='null'){
		$('#barcodeboleto').val('');
		$("#barcodeboleto").prop('disabled', false);
		$("#barcodeboleto").focus();
		$('#img_icono_error').show();
		$.gritter.add({ title : "VENTA NO REGISTRADA", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no est&aacute; asignado a un colaborador' });
		return false;
	}
	return true;
}

function InsertarVentaComprador(idsorteo,boleto,talonario,costo,pktalonario,pkboleto,pksector,pknicho,pkcolaborador) {
	
	var idsorteo = idsorteo;
	var boleto = boleto;
	var talonario = talonario;
	var costo = costo;
	var operacion = "InsertComprador";

	if(checaSectorNichoYColaborador(pksector,pknicho,pkcolaborador)==false){
		return;
	}

	var pktalonario = pktalonario;
	var pkboleto = pkboleto;
	var pksector = pksector;
	var pknicho = pknicho;
	var pkcolaborador = parseInt(pkcolaborador);
	

	var abono = costo;
	/*
	var nombre = '----------';
	var apellidos = '----------';
	var telefonofijo = '----------';
	var telefonomovil = '----------';
	var correo = '----------';
	var calle = '----------';
	var numero = '----------';
	var colonia = '----------';
	var estado = '----------';
	var municipio = '----------';
	*/

	var estadoboleto = "";


			$.ajax({
				type : "POST",
				cache : false,
				url : "BoletosSorteo",
				data : {
					operacion : operacion,
					extra : 'SoloVenta',
					sorteo : idsorteo,
					talonario : talonario,
					boleto : boleto,
					costo : costo,
					abono : abono,
					/*
					nombre : nombre,
					apellidos : apellidos,
					telefonofijo : telefonofijo,
					telefonomovil : telefonomovil,
					correo : correo,
					calle : calle,
					numero : numero,
					colonia : colonia,
					estado : estado,
					municipio : municipio,
					*/
					pkboleto : pkboleto,
					pksector : pksector,
					pknicho : pknicho,
					pkcolaborador : pkcolaborador,
					pktalonario : pktalonario
				},
				success : function(msg)
				{
					
					$('#barcodeboleto').val('');	
					$("#barcodeboleto").prop('disabled', false);
					$("#barcodeboleto").focus();
					$.gritter.add({
						title : "Correcto",
						text : 'El boleto <b style="color:#DED9BF;">' + ultimoFolio + '</b> se ha vendido con exito!',
					});
					
					
					BuscarBoletosTalonarios(idsorteo, pktalonario, talonario);
					
				},
				error : function(msg){
					$('#barcodeboleto').val('');	
					$("#barcodeboleto").prop('disabled', false);
					$("#barcodeboleto").focus();
					console.log('InsertarVentaComprador/ 1 /ajax/error');
				}
			});
		
}




function obtenerTalonario(){
	
	var folio = $('#barcodeboleto').val().trim();
	if (folio==''){
		$.gritter.add({ title : "ATENCION", text : 'Por favor escriba el folio del boleto a vender' });
		return;
	}
	$("#barcodeboleto").prop('disabled', true);
	ultimoFolio = folio;
	$.ajax({
		type: "GET",
		cache: false, 
		url: "RegistroVenta",  
		data: "view=getTalonario&folio="+folio,  
		success: function(msg){
			console.log('msg: \''+msg+'\'');
			limpia();
			if(msg==null || msg.trim()=='null'){
				
				$('#img_icono_error').show();
				$("#barcodeboleto").prop('disabled', false);
				$.gritter.add({ title : "VENTA NO REGISTRADA", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> no existe' });
				$("#barcodeboleto").focus();
				return;
			}
			
			var res = msg.split("|");
			
			
			if(res[14] == 1){
				
				$('#img_icono_error').show();
				$("#barcodeboleto").prop('disabled', false);
				$.gritter.add({ title : "VENTA NO REGISTRADA", text : 'El boleto <b style="color:#DED9BF;">'+ultimoFolio+'</b> es electr&oacute;nico' });
				$("#barcodeboleto").focus();
				return;
				
				
			}
			
			
	    	
			$("#foliotalon").html(res[0]);
			$("#numboletos").html(res[1]);
			//$("#montoabono").html("$"+res[2]);
			$("#montoabono").html("$0.0");


			var url = 'SeguimientoBoletos?idsorteo='+res[3]+'&amp;idboleto='+res[5];

			$("#btnseguimientotal").attr('href',url);
	    	
			//  1|11|300.00|46|300.00|18184|200001|null|null|null
			//  0 1  2      3  4      5     6      7    8    9
	    	
	    	InsertarVentaComprador(res[3],folio,res[0],res[4],res[5],res[6],res[7],res[8],res[9]);
	    	
	    	
	    	//if(msg.trim()=="TRUE"){
	    	
	    	/*$("#loaddeletecarga").hide();
	    	$("#contentcarga2").html('<span class="fa-stack fa-2x text-success"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-check fa-stack-1x fa-inverse"></i></span>');
	    	
	    	$.gritter.add({title:"TALONARIOS Y BOLETOS ELIMINADOS",text:"Los talonarios y boletos han sido eliminados del sorteo con exito"});
	    	
	    	refresh();*/
	    	
	             
	    }
	});
	
}




function BuscarBoletosTalonarios(sorteo, pk_talonario, idtalonario) {

	var idsorteo = sorteo;
	var talonario = idtalonario;
	
	$.ajax({
		type : "GET",
		cache : false,
		url : "BoletosSorteo",
		data : "view=BuscarBoletosTalonarios&sorteo=" + idsorteo
				+ "&talonario=" + talonario,
		success : function(msg) {

			$('#boletostalonario').html(msg);
			
			// La lista de boletos se trae un hidden con el monto acumulado.
			var monto = $('#input_monto_id').val();
			$("#montoabono").html("$"+monto);
			
			$('#img_icono_bien').show();

		},
		error : function(msg){
			console.log('BuscarBoletosTalonarios/ajax/error');
		}

	});

}



