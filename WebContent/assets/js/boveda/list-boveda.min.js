/*   
App Sorteo AnÃ¡huac
Version: 1.0
Author: Jose Carlos Ruiz Garcia
Website: http://www.redanahuac.mx/app/sorteo
*/

var pag = 1;

var boletosTalonario;
var totaldeboletos = 0;
var numboletostalon = 0;
var numtalonario = 1;
var boletos = []; 



var Listar=function(){"use strict";return{init:function(){ 
    
	handleListar()
	
}}}()


/*CARGA DE BOLETOS Y TALONARIOS*/



  function onkeyup_talonario_check(e)
    {
        var code = (e.which) ? e.which : e.keyCode;
        
        if(code==8)
        {
            //backspace
            return true;
        }
        else if(code>=48 && code<=57)
        {
            return true;
        }
        else if(code==13)
        {
        	if($("#barcodetalonario").val()!=""){
            	revisarTalonario();
            	}
            return true;
        }
        else
        {
        	//$("#barcodetalonario").val('');
            return false;
        }

    }



/*
function onkeyup_talonario_check(e){
	
	var enterKey = 13;
        if (e.which == enterKey){
        	
        	if($("#barcodetalonario").val()!=""){
        	revisarTalonario();
        	}
        }
}
*/




function onkeyup_boleto_check(e){
    
	/*
	var enterKey = 13;
        if (e.which == enterKey){
        	//handleListar()
        	
        	inputboleto();
        	    	
        }
        */
var code = (e.which) ? e.which : e.keyCode;
        
        if(code==8)
        {
            //backspace
            return true;
        }
        else if(code>=48 && code<=57)
        {
            return true;
        }
        else if(code==13)
        {
        	inputboleto();
            return true;
        }
        else
        {
        	//$("#barcodeboleto").val('');
            return false;
        }
        
}


function inputboleto(){
	
	
	if($("#barcodeboleto").val()!=""){
		
		var numboleto = $("#barcodeboleto").val();
		
		if(jQuery.inArray(numboleto, boletos) == -1){
			  
			if(numboletostalon<boletosTalonario){
			numboletostalon++;   
        	totaldeboletos++;
			}
		}
	
	if(numboletostalon==boletosTalonario){
		
		if(numtalonario<parseInt($("#numtalonario").val())){   
		
			if(numboletostalon<=boletosTalonario && boletos.length < numboletostalon ){
				
			var numboleto = $("#barcodeboleto").val();
			
			if(jQuery.inArray(numboleto, boletos) == -1 ){
    		 
    		boletos.push($("#barcodeboleto").val());
    		 
    		$("#numboleto").html(numboletostalon);
         	var spanboleto = '<a href="javascript:void(0)" id="boleto'+$("#barcodeboleto").val()+'" onClick="EliminarBoletoTalonario('+$("#barcodeboleto").val()+')"><span class="label label-primary" >'+$("#barcodeboleto").val()+'</span></a> '
         	$( "#btlnm" ).append( spanboleto );
         	$(".alert").remove();
         	
		    boletosTalonCompletos('next');
		     
    		}else{
   			 alert("YA EXISTE EL BOLETO, SORRY!!");
   			$("#barcodeboleto").val('');
        	$("#barcodeboleto").focus();
   		     }
		      
    		 }else{
    			$("#barcodeboleto").val('');
             	$("#barcodeboleto").focus();
    		 }
		
		
		 }else{
			 
			 if(numboletostalon<=boletosTalonario && boletos.length < numboletostalon ){
			 var numboleto = $("#barcodeboleto").val();
     		 if(jQuery.inArray(numboleto, boletos) == -1 ){
			 
     		 boletos.push($("#barcodeboleto").val());
     		 
     		$("#numboleto").html(numboletostalon);
         	var spanboleto = '<a href="javascript:void(0)" id="boleto'+$("#barcodeboleto").val()+'" onClick="EliminarBoletoTalonario('+$("#barcodeboleto").val()+')"><span class="label label-primary" >'+$("#barcodeboleto").val()+'</span></a> '
         	$( "#btlnm" ).append( spanboleto );
         	$(".alert").remove();
         	
         	boletosTalonCompletos('termino');
         	 
     		 }else{
     			alert("YA EXISTE EL BOLETO, SORRY!!");
     			$("#barcodeboleto").val('');
            	$("#barcodeboleto").focus();
     		 }
			}else{
     			
     			$("#barcodeboleto").val('');
            	$("#barcodeboleto").focus();
     		 }
			 

		 }
	
	}else{
		
		if(numboletostalon<=boletosTalonario){
		
			var numboleto = $("#barcodeboleto").val();
		if(jQuery.inArray(numboleto, boletos) == -1 ){
			
		boletos.push($("#barcodeboleto").val());
    	$("#numboleto").html(numboletostalon);
    	var spanboleto = '<a href="javascript:void(0)" id="boleto'+$("#barcodeboleto").val()+'" onClick="EliminarBoletoTalonario('+$("#barcodeboleto").val()+')"><span class="label label-primary" >'+$("#barcodeboleto").val()+'</span></a> '
    	$("#numboletosadd").show();
    	$( "#btlnm" ).append( spanboleto );
    	$(".alert").remove();
    	$("#barcodeboleto").val('');
    	$("#barcodeboleto").focus();
		}else{
			
			alert("YA EXISTE EL BOLETO, SORRY!!");
			$("#barcodeboleto").val('');
        	$("#barcodeboleto").focus();
		}
		
	  }
	
	}
	 }else{
		 
		 
	 }
	
}

function boletosTalonCompletos(statuscarga){
	
	
	if(validaAlgoritmo()){
	revisarBoletos(statuscarga);
	 }else{
		 
		 alert("EL TALONARIO QUE ESTA TRATANDO DE INGRESAR NO CUMPLE CON EL ALGORITMO VALIDO");
	 }
		
}


function validaAlgoritmo(){
	
	var talonario = $("#barcodetalonario").val();
	
	var boletosterminacion = [];
	var algoritmovalido = false;

	var lastCharTalonario = talonario.substr(talonario.length - 1);
	var lastCharBoletoInc = boletos[0].substr(boletos[0].length - 1);
	var lastCharBoletoUlt = boletos[10].substr(boletos[10].length - 1);

	   //SI EL ULTIMO NUMERO DE TALONARIO COINCIDE CON EL PRIMER BOLETO Y ULTIMA TERMINACION
	   if(lastCharTalonario == lastCharBoletoInc){
	         
			 //SI EL ULTIMO NUMERO DE TALONARIO COINCIDE CON EL ULTIMO BOLETO Y ULTIMA TERMINACION
	   if(lastCharTalonario == lastCharBoletoUlt){
	         algoritmovalido = true;
			 //alert('bien ultimo numero');
	   }else{
	         algoritmovalido = false;
			 //alert('mal ultimo numero');
	   }

	   }else{
	         algoritmovalido = false;
			 //alert('mal primer numero');
	   }
	   
	   
	   if(algoritmovalido){
	   //VALIDAR QUE SOLO EXISTA UN SOLO NUMERO REPETIDO
	         var contnumerorepetido = 0;
			 var terminacion = "";
			 var suma = 0;
	        for(var i=0; i<boletos.length; i++){
					boletosterminacion[i] = boletos[i].substr(boletos[i].length - 1);
					
					terminacion = boletosterminacion[i];
					suma += parseInt(terminacion);
					
					   for(var j=i+1; j<boletos.length; j++){
					             if(terminacion == (boletos[j].substr(boletos[j].length - 1))){
								     //alert("existe: "+boletos[i].substr(boletos[i].length - 1));
									 contnumerorepetido++;
								 }
					   }
			}
	   
	  
	   if(contnumerorepetido==1){
	     
		       if(suma-parseInt(lastCharTalonario)==45){
			       algoritmovalido = true;
				   //alert("algoritmo yes bien");
			   }else{
			        algoritmovalido = false;
					//alert("algoritmo mal mal");
			   }
		 
	   }else{
	   algoritmovalido = false;
	   //alert("algoritmo repetido");
	   }
	   
	   }//si algoritmo es valido al inicio
	   
	   
	   // alert(suma-parseInt(lastCharTalonario));
	   //alert(contnumerorepetido);
	   //alert("array"+boletosterminacion);
	   
	   return algoritmovalido;
	
}




function saveTalonario(monto){
	
	var folio = $("#hnumtalonario").val();
	var numboletos = $("#boletostal").val();
	var numsorteo = $("#idsorteo").val();
	var formato = $("#folio").val();
	var monto = parseFloat(monto.trim());
	
	
	$.ajax({ 
  	    type: "POST",  
        cache: false,
  	    url: "Talonarios", 
  	    data: { folio:folio,numboletos:numboletos,numsorteo:numsorteo,formato:formato,monto:monto},  
  	    success: function(msg){  
                       	    	
  	    	updateBoletosTalonario(msg.trim());          
  	    	
  	    	
  	            } 
  	           });

}

function updateBoletosTalonario(id){
	
	var talonario = $("#hnumtalonario").val();
	var sorteo = $("#idsorteo").val();
	var formato = $("#folio").val();
	var pktalonario = id;
	
	
	$.ajax({ 
  	    type: "GET", 
        cache: false, 
  	    url: "Boletos", 
  	    data: "view=UpdateBoletosTalonario&talonario="+talonario+"&sorteo="+sorteo+"&formato="+formato+"&pktalonario="+pktalonario,
  	    success: function(msg){  
                       	    	
  	    	$.gritter.add({title:"TALONARIO GUARDADO",text:"El talonario y sus boletos han sido guardados con exito"});

  		     refresh()

  		  setTimeout(function() {
  		      $.gritter.add({title:"EMPIEZA CARGA NUEVA",text:"Puede empezar a capturar"});
  	         }, 3000);       
  	    	
  	    	
  	            } 
  	           });
		
}


function CancelarTalonario(){
	
	    $("#colboletos").hide();
		$("#numboletosadd").hide();
		$( ".location" ).html('');
		$("#barcodetalonario").prop('disabled', false);
		$("#btntalonario").prop('disabled', false);
	    $('#btntalonario').show();
		$("#barcodetalonario").val('');
		$("#barcodetalonario").focus();
		$("#barcodeboleto").val('');
		
		$(".alert").remove();
		
		
	   //  numtalonario++;
	     numboletostalon = 0;
	     boletos = [];
	     $("#numboleto").html('0');
  	     $('#btntalonariocancel').hide();
  	
  	
	
}



function revisarTalonario(){
	
	var talonario = $("#barcodetalonario").val();
	var sorteo =  $('#idsorteo').val();
	var formato = $("#folio").val();
	

	$.ajax({ 
  	    type: "GET",  
  	    url: "Boletos", 
        cache: false,
  	    data: "view=RevisarTalonario&talonario="+talonario+"&sorteo="+sorteo+"&formato="+formato,  
  	    success: function(msg){ 
  	    	
  	    	if(msg.trim()==""){
  	    		//EL TALONARIO NO EXISTE
  	    		
  	    		$("#hnumtalonario").val($("#barcodetalonario").val());
  	        	$("#barcodetalonario").prop('disabled', true);
  	        	$("#btntalonario").prop('disabled', true);
  	        	$('#btntalonario').hide();
  	        	
  	        	$('#btntalonariocancel').show();
  	        	
  	        	$("#colboletos").show();
  	        	$("#barcodeboleto").focus();
  	        	
  	        	boletosTalonario = $("#boletostal").val();
  	        	$("#totalnumboleto").html($("#boletostal").val());
  	    		
  	    		
  	    	}else{
  	    	    //EL TALONARIO EXISTE
  	    		alert("EL TALONARIO YA EXISTE, SORRY!!");
  	    		$("#barcodetalonario").val('');
  	    		$("#barcodetalonario").focus();
  	    		
  	    	}
  	    	
  	    	
  	         }	
  	    });
	
}


function revisarBoletos(statuscarga){
	var aboletos = boletos.join(); 
	var talonario =  $('#hnumtalonario').val();
	var sorteo =  $('#idsorteo').val();
	var formato = $("#folio").val();
	
	var respuesta = "";
	
	$.ajax({ 
  	    type: "GET",  
  	    url: "Boletos", 
        cache: false,
  	    data: "view=RevisarBoletos&boletos="+boletos+"&talonario="+talonario+"&sorteo="+sorteo+"&formato="+formato,  
  	    success: function(msg){  
  	    	
  	    
  	    	if(msg.trim()==""){
  	    		
  	    	
  	    		if(statuscarga.trim()=="next"){	
  	    	$("#colboletos").hide();
  	  		$("#numboletosadd").hide();
  	  		$( ".location" ).html('');
  	  		$("#barcodetalonario").prop('disabled', false);
  	  		$("#btntalonario").prop('disabled', false);
  	  	    $('#btntalonario').show();
  	  		$("#barcodetalonario").val('');
  	  		$("#barcodetalonario").focus();
  	  		
  	  	     numtalonario++;
  	  	     numboletostalon = 0;
  	  	     $(".alert").remove();
  	  	     $('#btntalonariocancel').hide();
  	  	     $("#numboleto").html('0');
	         $("#barcodeboleto").val('');
	         $("#spannumtalonario").html(numtalonario);
	         $("#numtalonariosadd").html(numtalonario-1);
  	    		}else{
  	    			
  	    			   

  	    		
  	    			 $("#formtalonarios").hide();
        			 $("#numboletosadd").hide();
        			 $("#cargacompleta").show();
        			 
        			 
        			 $("#talonarioscomplete").html(numtalonario);
        			 $("#boletoscomplete").html(boletosTalonario);
        			 $("#totalboletoscomplete").html(totaldeboletos);
        			 $("#folioformato").html($("#folio").val());
        			 
        			 
        			 
        			    totaldeboletos = 0;
	    			    numboletostalon = 0;
	    			    numtalonario = 1;
  	    			
  	    			
  	    		}
  	  		
	     saveBoletos();
	     
  	    	}else{
  	    		$("#barcodeboleto").val('');
  	    	var alerta = '<div class="alert alert-danger fade in m-b-15"><strong>ERROR!</strong>  LOS BOLETOS MARCADOS EN ROJO YA EXISTEN, por favor eliminalos seleccionandolos.<span data-dismiss="alert" class="close">X</span></div>';
			
  	    	$(".alert").remove();
  	    		$("#numboletosadd").append(alerta);		
  	    		var res = msg.split(",");
  	    		
  	    		for (var i = 0; i < res.length; i++) {
  	    		  
  	    			$( "#boleto"+res[i]+" span" ).removeClass( "label label-primary" ).addClass( "label label-danger" );
  	    		}
  	    		
  	    	}
  	    	
  	    	
  	            } 
  	           });
	
	  return respuesta;
	
}


function saveBoletos(){
	
	var aboletos = boletos.join(); 
	var costo = parseFloat($('#costo').val());
		
	var talonario =  $('#hnumtalonario').val();
	var sorteo =  $('#idsorteo').val();
	var formato = $("#folio").val();
	
	
	$.ajax({ 
  	    type: "POST",  
  	    url: "Boletos", 
        cache: false,
  	    data: { boletos:aboletos,talonario:talonario,costo:costo,sorteo:sorteo,formato:formato},  
  	    success: function(monto){  
  	    	
  	    	
  	    	boletos = [];
  	    	
  	    	
  	    	saveTalonario(monto);
  	    	
  	    	      //$.gritter.add({title:"TALONARIO GUARDADO",text:"El talonario y sus boletos han sido guardados con exito"});

  	  	          //handleListar()
  	  	
            	  /*setTimeout(function() {
  	  		      $.gritter.add({title:"EMPIEZA CARGA NUEVA",text:"Puede empezar a capturar"});
  	  	          }, 3000);*/
           
  	            } 
  	           });
	
	
}


/*END CARGA DE BOLETOS Y TALONARIOS*/



function EliminarBoletoTalonario(id){
	

	var elimina = confirm("Desea eliminar el boleto con FOLIO: "+id);
	
	if(elimina){
		
		var i = boletos.indexOf(""+id);
		if(i != -1) {
			boletos.splice(i, 1);
		
			numboletostalon--;   
	    	totaldeboletos--;
	    	
	    	$('#numboleto').html(numboletostalon);
			$('#boleto'+id).remove();
		
		}
		
    	
    	
		
	}
	
}


function onkeyup_colfield_check(e){
    var enterKey = 13;
        if (e.which == enterKey){
        	handleListar()
        }
}

    function changeShow(){
    	
    	handleListar()
    }

    function getPag(page){
	
	pag = page;
	 handleListar()
    }

    
    function newCarga(){
    	
    	
    }
    
    

    function configuracion(idsorteo,sorteoname){
    	
    	$('#idsorteo').val(idsorteo);
    	
    	var sorteo = idsorteo;
    	$('#sorteoname').html('<h3>'+sorteoname+'</h3>');
    	
    	
    	$('#formConfig').show();
		$('#formeliminarsorteo').hide();
		$('#cargaBoletos').hide();
		$('#formeliminarcargasorteo').hide();
		$('#formato').hide();
		$('#cargacompleta').hide();
		$('#formtalonarios').hide();
		$('#numboletosadd').hide();
		$('#btlnm').html('');
		
		
    	
    	$('#myModalConfiguracion').modal({
    		show: true,
    		backdrop: 'static'
    		});
    	
    	
    	$.ajax({ 
       	    type: "GET",  
            cache: false,
       	    url: "Boveda.do",  
       	    data: "view=ExisteCarga&sorteo="+sorteo,  
       	    success: function(msg){ 

       	    	  if(msg.trim()=="TRUE"){
       	    		  
       	    	     $('#btncargaboletos').removeClass( "btn btn-success btn-lg" ).addClass( "btn btn-success btn-lg disabled");
       	    	     $('#btndeletecargaboletos').removeClass( "btn btn-success btn-lg" ).addClass( "btn btn-success btn-lg disabled");
       	    	    
       	    	         
       	    	  }else{
       	    		  
       	    		 $('#btncargaboletos').removeClass( "btn btn-success btn-lg disabled" ).addClass( "btn btn-success btn-lg");
       	    		 $('#btndeletecargaboletos').removeClass( "btn btn-success btn-lg disabled" ).addClass( "btn btn-success btn-lg");
       	    		
       	    	  }
       	    	
       	             } 
       	   
       	           });
    	
    	
    }
    
    
    function mostrarFormatoCarga(){
    	
    	$('#cargaBoletos').hide();
    	$('#formato').show();
    	$('#formtalonarios').hide();
    	
    	$('#cargacompleta').hide();
    	
    	$('#folio').val('');
    	
    	$("#colboletos").hide();
    	
        $("#numtalonariosadd").html('1');
    	$("#spannumtalonario").html('1');
    	
    	$( "#btlnm" ).html('');
    	
    	totaldeboletos = 0;
		numboletostalon = 0;
		numtalonario = 1;
		boletos = [];
    	
    	//$('#aceptarmodal').removeAttr( "onClick" );
    	//$("#aceptarmodal").attr("onClick","cargaTalonarios()");
    	//$('#aceptarmodal').click(stopMoving);
    	
    }
    
    
    
    function cargaTalonarios(){
    
    	
    	if($('#folio').val()!="" && $('#costo').val()!=""){
    	
    	$('#formato').hide();
    	$('#formtalonarios').show();
    	
    	$("#barcodetalonario").focus();
    	
    	$('#numtalonarios').html($('#numtalonario').val());
    	$('#numboletos').html($('#boletostal').val());
    	
    	$('#numboleto').html('0');
    	
    	$('#btntalonariocancel').hide();
    	
    	
    	$("#barcodetalonario").prop('disabled', false);
    	$("#btntalonario").prop('disabled', false);
    	$("#barcodetalonario").val('');
    	$("#barcodetalonario").focus();
    	$("#barcodeboleto").val('');
    	}else{
    		
    		alert("Ingrese Folio y/o Costo de Boleto");
    	}
    	
    	
    }
    
    
    function mostrarFormato(value){
    	
    	
    	switch(value){
    		
       case "cargaboletos":
    	   $('#formtalonarios').hide();
    		$('#formConfig').hide();
    		$('#formeliminarcargasorteo').hide();
    		$('#formeliminarsorteo').hide();
    		$('#cargaBoletos').show();
    		$('#btncargaboletossorteo').show();
    		$("#mensajec").html('<h1>Cargar Talonarios y Boletos de Boveda</h1><br>');
    		$("#contentcarga").html('');
    		
    		
    		break;
    		
       case "deletecargaboletos":

    	    $('#cargaBoletos').hide();
    		$('#formConfig').hide();
    		$('#formeliminarsorteo').hide();
    		$('#formeliminarcargasorteo').show();
    		$("#eliminarlabeldeltecarga").show();
        	$("#btneliminardeltecarga").show();
        	$("#deletecargasorteoconfirm").show(); 
        	$("#deletecargasorteoconfirm").val('');
        	$("#contentcarga2").html('');
        	
        	
    		break;
    		
    		
       case "deletesorteo":
    	$('#cargaBoletos').hide();
   		$('#formConfig').hide();
   		$('#formeliminarcargasorteo').hide();
   		$('#formeliminarsorteo').show();
   		
   		
   		break;
    		
    	
    	}
    	
    	
    	
    }
    
    
    
    
    
    function eliminarCargaSorteo(){
    	
    	var sorteo = $('#idsorteo').val(); 
        var textconfirm = $("#deletecargasorteoconfirm").val();
        
        
        if(textconfirm=="ELIMINAR"){
        	
        	var eliminar = confirm("Se eliminaran todos los talonarios y boletos asigandos al sorteo");
        	
            if(eliminar){
            	
            	
            	$("#contentcarga2").html('<img src="assets/img/load.gif" id="loaddeletecarga" /><br><h2> Eliminando..</h2>');
            	
            	$("#eliminarlabeldeltecarga").hide();
            	$("#deletecargasorteoconfirm").hide();
            	$("#btneliminardeltecarga").hide();
            
        	$.ajax({ 
        	    type: "GET", 
              cache: false, 
        	    url: "Boveda.do",  
        	    data: "view=EliminarCarga&sorteo="+sorteo,  
        	    success: function(msg){ 
        	    	
        	    	//if(msg.trim()=="TRUE"){
        	    	//$('#myModalConfiguracion').modal('hide');
        	    	
        	    	$("#loaddeletecarga").hide();
        	    	$("#contentcarga2").html('<span class="fa-stack fa-2x text-success"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-check fa-stack-1x fa-inverse"></i></span>');
        	    	
        	    	$.gritter.add({title:"TALONARIOS Y BOLETOS ELIMINADOS",text:"Los talonarios y boletos han sido eliminados del sorteo con exito"});
        	    	
        	    	refresh();
        	    	
        	             // } 
        	    }
        	   
        	           });
            }
        	}else{
        		
        		alert("INGRESE LA PALABRA CORRECTAMENTE");
        		
        	}
        
    }
    
    
   

    
    
    function refresh(){
    	
    	 var show =	"10";
         var search =	$("#searchtable").val();
         var submenu = $("#boveda_submenu_id").val();
        
    	
    	$.ajax({ 
    	    type: "GET",  
          cache: false,
    	    url: "Boveda.do",  
    	    data: "view=Buscar&pg="+pag+"&show="+show+"&sub="+submenu+"&search="+search,  
    	    success: function(msg){  
    	    	
    	    	
    	    	$("#listresultados").html(msg);
    	    	
    	    	$("[data-toggle=tooltip]").tooltip();
    	    	$("[data-toggle=popover]").popover();
    	    	
    	    	
    	               } 
    	   
    	           });
    	
    	
    	
    }
    
    
var handleListar = function(){
	var show =	"10";
	var search =	$("#searchtable").val();
	var submenu = $("#boveda_submenu_id").val();
	
	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
		overlayCSS: {backgroundColor: '#FFF'},
		message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	}); 
	
	$.ajax({
		type: "GET",  
    cache: false,
		url: "Boveda.do",  
		data: "view=Buscar&pg="+pag+"&show="+show+"&sub="+submenu+"&search="+search,  
		success: function(msg){
			
			$('div.block').unblock(); 
			$("#listresultados").html(msg);
			
			$("[data-toggle=tooltip]").tooltip();
			$("[data-toggle=popover]").popover();
		}
	});
}
