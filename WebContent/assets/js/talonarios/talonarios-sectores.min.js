/*   
App Sorteo An√°huac
Version: 1.0
Author: Jose Carlos Ruiz Garcia
Website: http://www.redanahuac.mx/app/sorteo
*/

var pag = 1;

var boletosTalonario;
var totaldeboletos = 0;
var numboletostalon = 0;
var numtalonario = 1;
var boletos = []; 


var Listar=function(){
	"use strict";
	return{
		init:function(){
			handleListar()
		}
	}
}()

function onkeyup_talonario_check(e){
    
	var enterKey = 13;
        if (e.which == enterKey){
        	
        	
        	$("#hnumtalonario").val($("#barcodetalonario").val());
        	$("#barcodetalonario").prop('disabled', true);
        	$("#btntalonario").prop('disabled', true);
        	
        	$("#colboletos").show();
        	$("#barcodeboleto").focus();
        	
        	boletosTalonario = $("#boletostal").val();
        	$("#totalnumboleto").html($("#boletostal").val());
        	
        }
}

function onkeyup_boleto_check(e){
    
	var enterKey = 13;
        if (e.which == enterKey){
        	//handleListar()
        	
        	if($("#barcodeboleto").val()!=""){
        	numboletostalon++;   
        	totaldeboletos++;
        	
        	if(numboletostalon==boletosTalonario){
        		
        		boletos.push($("#barcodeboleto").val());
        		
        		 if(numtalonario<$("#numtalonario").val()){   
        		numtalonario++;
        		numboletostalon = 0;
        		boletosTalonCompletos();
        		$("#numboleto").html('1');
        		$("#barcodeboleto").val('');
        		$("#spannumtalonario").html(numtalonario);
        		$("#numtalonariosadd").html(numtalonario-1);
        		 }else{
        			 
        			 boletosTalonCompletos();
        			 
        			 $("#formtalonarios").hide();
        			 $("#numboletosadd").hide();
        			 $("#cargacompleta").show();
        			 
        			 
        			 $("#talonarioscomplete").html(numtalonario);
        			 $("#boletoscomplete").html(boletosTalonario);
        			 $("#totalboletoscomplete").html(totaldeboletos);
        			 $("#folioformato").html($("#folio").val());
        			 

        		 }
        	
        	}else{
        		
        		boletos.push($("#barcodeboleto").val());
            	$("#numboleto").html(numboletostalon);
            	var spanboleto = '<span class="label label-primary">'+$("#barcodeboleto").val()+'</span> '
            	$("#numboletosadd").show();
            	$( "#btlnm" ).append( spanboleto );
            	$("#barcodeboleto").val('');
            	$("#barcodeboleto").focus();
        		
        	}
        	 }else{
        		 
        		 
        	 }
        	    	
        }
}


function boletosTalonCompletos(){
	
	//alert("Boletos Completos de talonario");
	
	$("#colboletos").hide();
	$("#numboletosadd").hide();
	
	$( ".location" ).html('');
	
	$("#barcodetalonario").prop('disabled', false);
	$("#btntalonario").prop('disabled', false);
	
	$("#barcodetalonario").val('');
	$("#barcodetalonario").focus();
	   
	//saveTalonario();
	saveBoletos();
	
}



function saveTalonario(monto){
	

	
	var folio = $("#hnumtalonario").val();
	var numboletos = $("#boletostal").val();
	var numsorteo = $("#numsorteo").val();
	var formato = $("#folio").val();
	var monto = parseFloat(monto.trim());
	
	
	
	
	
	
	$.ajax({ 
  	    type: "POST",  
  	    cache: false,
  	    url: "Talonarios", 
  	    data: { folio:folio,numboletos:numboletos,numsorteo:numsorteo,formato:formato,monto:monto},  
  	    success: function(msg){  
  	    	
  	    	      $.gritter.add({title:"TALONARIO GUARDADO",text:"El talonario y sus boletos han sido guardados con exito"});

  	  	          handleListar()
  	  	
            	  setTimeout(function() {
  	  		      $.gritter.add({title:"EMPIEZA CARGA NUEVA",text:"Puede empezar a capturar"});
  	  	          }, 3000);
           
  	            } 
  	           });

}


function saveBoletos(){
	
	var aboletos = boletos.join(); 
	var costo = parseFloat($('#costo').val());
		
	var talonario =  $('#hnumtalonario').val();
	var sorteo =  $('#numsorteo').val();
	var formato = $("#folio").val();
	
	
	$.ajax({ 
  	    type: "POST",  
  	    cache: false,
  	    url: "Boletos", 
  	    data: { boletos:aboletos,talonario:talonario,costo:costo,sorteo:sorteo,formato:formato},  
  	    success: function(monto){  
  	    	
  	    	
  	    	
  	    	
  	    	boletos = [];
  	    	
  	    	
  	    	saveTalonario(monto);
  	    	
  	    	      //$.gritter.add({title:"TALONARIO GUARDADO",text:"El talonario y sus boletos han sido guardados con exito"});

  	  	          //handleListar()
  	  	
            	  /*setTimeout(function() {
  	  		      $.gritter.add({title:"EMPIEZA CARGA NUEVA",text:"Puede empezar a capturar"});
  	  	          }, 3000);*/
           
  	            } 
  	           });
	
	
}



function eliminarTalonario(id,folio,numsorteo,formato){
	
	var eliminar = true;
	
	if(confirm("Esta seguro de eliminar este talonario?")){
		
	$.ajax({ 
  	    type: "POST", 
  	    cache: false, 
  	    url: "Talonarios", 
  	    data: { id:id,folio:folio,numsorteo:numsorteo,formato:formato,eliminar:eliminar},  
  	    success: function(monto){  
  	    	
  	    	     $('#talonario'+id).hide('slow', function(){ $('#talonario'+id).remove(); });  
  	    	      $.gritter.add({title:"TALONARIO ELIMINADO",text:"El talonario y sus boletos han sido eliminados con exito"});

  	  	          //handleListar()
  	  	
           
  	            } 
  	           });
	
	}
	
	
	
	
}





function onkeyup_colfield_check(e){
    var enterKey = 13;
        if (e.which == enterKey){
        	handleListar()
        }
}



function changeShow()
{
	handleListar()
}

function getPag(page)
{
	pag = page;
	handleListar()
}
    
    
$('#myModal').on('hide.bs.modal', function (e) {
// do something...
confirm("Esta seguro de suspender la carga de Talonarios");	
});

/**/
function iniciaTalonarioSector(){
	
	$('#instrucciones').show();
	$('#formato').hide();
	$('#formtalonarios').hide();
	$('#cargacompleta').hide();
	
	//$('#myModal').modal('show');
	
	$('#myModal').modal({
		show: true,
		backdrop: 'static'
		})
	
	$('#aceptarmodal').removeAttr( "onClick" );
	$("#aceptarmodal").attr("onClick","mostrarFormato()");
}
//*/


function mostrarFormato(){
	
	$('#instrucciones').hide();
	$('#formato').show();
	$('#formtalonarios').hide();
	
	$('#aceptarmodal').removeAttr( "onClick" );
	$("#aceptarmodal").attr("onClick","cargaTalonarios()");
}



function cargaTalonarios(){
	
	
	$('#instrucciones').hide();
	$('#formato').hide();
	$('#formtalonarios').show();
	
	$("#barcodetalonario").focus();
	
	$('#numtalonarios').html($('#numtalonario').val());
	$('#numboletos').html($('#boletostal').val());
	
}



var handleListar = function()
{
	var show =	"10";
	var search =	$("#searchtable").val();
	
	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
		overlayCSS: {backgroundColor: '#FFF'},
		message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	});
	
	
	$.ajax({
		type: "GET",
		cache: false,
		url: "TalonariosSectores",
		data: "view=Buscar&pg="+pag+"&show="+show+"&search="+search,
		success: function(msg){
			$('div.block').unblock();
			$("#listresultados").html(msg);
			$("[data-toggle=tooltip]").tooltip();
			$("[data-toggle=popover]").popover();
		}
	});
}





