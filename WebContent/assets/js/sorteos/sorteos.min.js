/*   
App Sorteo An√°huac
Version: 1.0
Author: Jose Carlos Ruiz Garcia
Website: http://www.redanahuac.mx/app/sorteo
*/

var pag = 1;


var Listar = function() {
	"use strict";
	return {
		init : function() {
			handleListar();
		}
	}
}()



function onkeyup_colfield_check(e) {
	var enterKey = 13;
	if (e.which == enterKey) {
		handleListar();
	}
}
function btnBuscar_click() {
	pag = 1;
	handleListar();
}

function changeShow(){
	
	handleListar();
}

function getPag(page) {

	pag = page;
	handleListar();
}


function configuracion(idsorteo, sorteoActivo){
	
	$('#idsorteo').val(idsorteo);
	$('#sorteoActivo').val(sorteoActivo);
	
	var sorteo = idsorteo;
	
	$('#formConfig').show();
	$('#formeliminarsorteo').hide();
	$('#cargaBoletos').hide();
	$('#formeliminarcargasorteo').hide();
	$('#diviniciosorteo').hide();
	
	$('#myModalConfiguracion').modal({
		show: true,
		backdrop: 'static'
	});
	//$('#myModalConfiguracion').show();
	
	$.ajax({
		type: "GET",
		cache: false,
		url: "Sorteos.do",
		data: "view=ExisteCarga&sorteo="+sorteo,
		success: function(msg){

			if(msg.trim()=="TRUE"){

				$('#btncargaboletos').removeClass( "btn btn-success btn-lg" ).addClass( "btn btn-success btn-lg disabled");
				$('#btndeletecargaboletos').removeClass( "btn btn-success btn-lg" ).addClass( "btn btn-success btn-lg disabled");
				$('#btneliminarsorteo').removeClass( "btn btn-success btn-lg" ).addClass( "btn btn-success btn-lg disabled");

			}else{

				$('#btncargaboletos').removeClass( "btn btn-success btn-lg disabled" ).addClass( "btn btn-success btn-lg");
				$('#btndeletecargaboletos').removeClass( "btn btn-success btn-lg disabled" ).addClass( "btn btn-success btn-lg");
				$('#btneliminarsorteo').removeClass( "btn btn-success btn-lg disabled" ).addClass( "btn btn-success btn-lg");
			}
			
			var activo = ($('#sorteoActivo').val()==1);
	    	if(activo){
	    		$('#btncargaboletos').removeClass('disabled');
	    		$('#btndeletecargaboletos').removeClass('disabled');
	    		$('#btneliminarsorteo').removeClass('disabled');

	    		$('#iniciosorteo').addClass('disabled');
	    		$('#cerrarsorteo').removeClass('disabled');
	    	}
	    	else{
	    		$('#btncargaboletos').addClass('disabled');
	    		$('#btndeletecargaboletos').addClass('disabled');
	    		$('#btneliminarsorteo').addClass('disabled');

	    		$('#iniciosorteo').removeClass('disabled');
	    		$('#cerrarsorteo').addClass('disabled');
	    	}
		}
	});
}


function mostrarFormato(value){
	
	switch(value){
		
   case "cargaboletos":

		$('#formConfig').hide();
		$('#diviniciosorteo').hide();
		$('#formeliminarcargasorteo').hide();
		$('#formeliminarsorteo').hide();
		$('#cargaBoletos').show();
		$('#btncargaboletossorteo').show();
		$("#mensajec").html('<h1>Cargar Talonarios y Boletos de Boveda</h1><br>');
		$("#contentcarga").html('');
		
		
		break;
		
   case "iniciocierre":
	   
	$('#diviniciosorteo').show();
	$('#formConfig').hide();
	$('#formeliminarcargasorteo').hide();
	$('#formeliminarsorteo').hide();
	
	 break;
	   
	   
		
   case "deletecargaboletos":

		$('#cargaBoletos').hide();
		$('#diviniciosorteo').hide();
		$('#formConfig').hide();
		$('#formeliminarsorteo').hide();
		$('#formeliminarcargasorteo').show();
		$("#eliminarlabeldeltecarga").show();
		$("#btneliminardeltecarga").show();
		$("#deletecargasorteoconfirm").show(); 
		$("#deletecargasorteoconfirm").val('');
		$("#contentcarga2").html('');
		
		
		break;
		
		
   case "deletesorteo":
		$('#cargaBoletos').hide();
		$('#diviniciosorteo').hide();
		$('#formConfig').hide();
		$('#formeliminarcargasorteo').hide();
		$('#formeliminarsorteo').show();

		break;
	
	}
}



    
    
//CARGA DE BOLETOS SORTEO
function cargarBoletos(){
	
	var sorteo = $('#idsorteo').val();
	var textconfirm = $("#deletesorteoconfirm").val();
	var total = "";
	var mensaje = "";

	var confirmado = confirm("Se asignaran todos los talonarios y boletos de boveda");
	
	if(confirmado){
		
		resetTimer();
		
		$("#btncargaboletossorteo").hide();
		$("#progressbarsection").show();
		$("#contentcarga").html('<img src="assets/img/load.gif" id="loadcarga" /><br><h2> Cargando..</h2>');
		
		$.ajax({
			type: "POST",
			cache: false,
			url: "Sorteos.do",
			data: {cargar:'cargar',sorteo:sorteo},
			complete: function(msg){
				closeTimer();
			},
			success: function(msg){
				closeTimer();
				$("#loadcarga").remove();
				$("#progressbarsection").hide();
				
				total = msg.split(":");
				mensaje = "<h1>Se han ASIGNADO #Talonarios: "+total[0]+" ,#Boletos:"+total[1]+" al sorteo!!</h1><br>";
				
				$("#mensajec").html(mensaje);
				
				$("#contentcarga").html('<span class="fa-stack fa-2x text-success"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-check fa-stack-1x fa-inverse"></i></span>');
				
				$.gritter.add({title:"OPERACION EXITOSA",text:"Los talonarios y Boletos han sido asignados con exito al sorteo"});
				
				refresh();
			},
			error: function(msg){
				closeTimer();
				$("#loadcarga").remove();
				$("#progressbarsection").hide();
			}
		});
	}
	
}
    
    
function eliminarCargaSorteo(){
    	
    	var sorteo = $('#idsorteo').val(); 
    var textconfirm =	$("#deletecargasorteoconfirm").val();
    
    
    if(textconfirm=="ELIMINAR"){
    	
    	var eliminar = confirm("Se eliminaran todos los talonarios y boletos asigandos al sorteo");
    	
        if(eliminar){
        	
        	$("#contentcarga2").html('<img src="assets/img/load.gif" id="loaddeletecarga" /><br><h2> Eliminando..</h2>');
        	
        	$("#eliminarlabeldeltecarga").hide();
        	$("#deletecargasorteoconfirm").hide();
        	$("#btneliminardeltecarga").hide();
        
    	$.ajax({ 
    	    type: "GET",  
          cache: false,
    	    url: "Sorteos.do",  
    	    data: "view=EliminarCarga&sorteo="+sorteo,  
    	    success: function(msg){ 
    	    	
    	    	//if(msg.trim()=="TRUE"){
    	    	//$('#myModalConfiguracion').modal('hide');
    	    	
    	    	$("#loaddeletecarga").hide();
    	    	$("#contentcarga2").html('<span class="fa-stack fa-2x text-success"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-check fa-stack-1x fa-inverse"></i></span>');
    	    	
    	    	$.gritter.add({title:"TALONARIOS Y BOLETOS ELIMINADOS",text:"Los talonarios y boletos han sido eliminados del sorteo con exito"});
    	    	
    	    	refresh();
    	    	
    	             // } 
    	    }
    	   
    	           });
        }
    	}else{
    		
    		alert("INGRESE LA PALABRA CORRECTAMENTE");
    		
    	}
    
}


//ELIMINAR SORTEO
function eliminarSorteo(){
	
	 var sorteo = $('#idsorteo').val(); 
     var textconfirm =	$("#deletesorteoconfirm").val();
     var borrar = "eliminar";
    
	if(textconfirm=="ELIMINAR"){
	
	var eliminar = confirm("Se eliminaran todos los datos del Sorteo");
	
    if(eliminar){
    
	$.ajax({ 
	    type: "POST", 
      cache: false, 
	    url: "Sorteos.do",  
	    data: {eliminar:borrar,sorteo:sorteo},  
	    success: function(msg){
	    	
	    	 
	    	$('#myModalConfiguracion').modal('hide');
	    	$.gritter.add({title:"SORTEO ELIMINADO",text:"El Sorteo ha sido eliminado con exito"});
	    	refresh();
	    	
	               } 
	   
	           });
    }
	}else{
		
		alert("INGRESE LA PALABRA CORRECTAMENTE");
		
	}
	
	
}

    
    
function refresh() {

	var show = "10";
	var search = $("#searchtable").val();

	$.ajax({
		type : "GET",
		cache : false,
		url : "Sorteos.do",
		data : "view=Buscar&pg=" + pag + "&show=" + show + "&search=" + search,
		success : function(msg) {

			$("#listresultados").html(msg);

			$("[data-toggle=tooltip]").tooltip();
			$("[data-toggle=popover]").popover();

		}

	});
}
    
var handleListar = function() {

	var show = "10";
	var search = $("#searchtable").val();
	
	$('div.block').block({ 
			css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
			overlayCSS: {backgroundColor: '#FFF'},
			message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	});
	
	$.ajax({
		type : "GET",
		cache : false,
		url : "Sorteos.do",
		data : "view=Buscar&pg=" + pag + "&show=" + show + "&search=" + search,
		success : function(msg) {

			$('div.block').unblock();
			$("#listresultados").html(msg);

			$("[data-toggle=tooltip]").tooltip();
			$("[data-toggle=popover]").popover();

		}
	});
}
	
function iniciarSorteo(){
	var idsorteo = $('#idsorteo').val();
	$.ajax({
		type: "POST",
		cache: false, 
		url: "Sorteos.do",  
		data: "activar=activar&idsorteo="+idsorteo,
		complete:function(msg){
		},
		success: function(msg)
		{
			var index_1=msg.indexOf('<result>');
			var index_2=msg.indexOf('</result>');
			
			if (0<=index_1 && index_1<index_2)
			{
				var result = msg.substring(index_1+8, index_2);
				if(result=="1")
				{
					$.gritter.add({
						title : "Sorteo",
						text : "El sorteo se ha activado"
					});
				}
				handleListar();
			}
			$('#myModalConfiguracion').modal('hide');
		}
	});
}

function cerrarSorteo()
{
	var idsorteo = $('#idsorteo').val();
	$.ajax({
		type: "POST",
		cache: false, 
		url: "Sorteos.do",  
		data: "activar=desactivar&idsorteo="+idsorteo,
		complete:function(msg){
		},
		success: function(msg)
		{
			var index_1=msg.indexOf('<result>');
			var index_2=msg.indexOf('</result>');
			
			if (0<=index_1 && index_1<index_2)
			{
				var result = msg.substring(index_1+8, index_2);
				if(result=="1")
				{
					$.gritter.add({
						title : "Sorteo",
						text : "El sorteo se ha cerrado"
					});
				}
				handleListar();
			}
			
			//$('#myModalConfiguracion').hide();
			$('#myModalConfiguracion').modal('hide');
		}
	});
}






//___________________________________________________________________________
var timerProgressBar=null;
function resetTimer(){
	closeTimer();
	//console.log('resetTimer');
	timerProgressBar = setInterval(timerProgressBar_Tick, 5000);
}
function closeTimer(){
	//console.log('closeTimer');
	if(timerProgressBar!=null){
		clearTimeout(timerProgressBar);
		timerProgressBar=null;
	}
}
function timerProgressBar_Tick(){
	
	closeTimer();
	$.ajax({
 	    type: 'GET',
 	    url: 'ProgressBar',
 	    data: '',
		complete: function(msg){
		},
 	    success: function(msg)
		{
			if(msg != null && msg.length<5){
				$('#div_porcentaje_id').html(msg+" %");
				console.log('      porcentaje:'+msg);
				$('#progressbar_loading').val(msg);
				
			}
			
			resetTimer();
		}
	});
}
// ___________________________________________________________________________


