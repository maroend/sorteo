
//var numpremio=0;
//var global = 'false';
var elem = document.querySelector('.js-switch');
var init = new Switchery(elem);
var handleBootstrapWizards=function(){"use strict";$("#wizard").bwizard()};

var FormWizard=function(){"use strict";return{init:function(){
	handleBootstrapWizards();
	
	$('#div_sec_id').show();
	$('#img_loading_sec_id').hide();
	$('#div_nic_id').hide();
	$('#img_loading_nic_id').hide();
	$('#div_img_loading_id').hide();
	$('#div_btns_id').hide();
	consultaSectores();
}}}()


$(function(){
	
	 $('previous').attr('aria-disabled',true);  
	
});//End function jquery




$("#wizard").bwizard({validating:function(e,t){

	if (t.index==0) {
		
		var sector = $('#select_sector_id').val();
		var nicho = $('#select_nicho_id').val();
		if (sector == null || sector == '' || sector == 'S' || nicho == null || nicho == '')
			return false;
	}
	else if(t.index==1){
		if (t.nextIndex	== 2){
			if(false===$('form[name="form-wizard"]').parsley().validate("wizard-step-1"))
				return false

			uploadFile(processFile);
		}
	}
}});



var processFile = function(fileName){
	var idsector = $('#select_sector_id').val();
	var idnicho = $('#select_nicho_id').val();
 	$.ajax({
		type: 'GET',
		url: 'Colaboradores.do',
		data: {
			"view":"LoadExcelFile",
			"fileName":fileName,
			"idsector":idsector,
			"idnicho":idnicho,
		},
		success : function(msg) {
			
			var HTML = '<tr>  <th>N&#176;</th>  <th>Clave</th>  <th>Nombre</th>  <th>Registro</th>  </tr>';
			
			try {
				data=jQuery.parseJSON(msg);
				for(var j=0; j<data.length; j++)
				{
					var row=data[j];
					
					var style = row.upd=='1' ? 'background-color:#DDEEDD;' : '';
					if(row.res=='OK'){
						HTML+=
						'<tr style="'+style+'">'+
							'<td style="text-align:left; margin:1pt;">'+row.row+'</td>'+
							'<td style="text-align:left; margin:1pt;">'+row.cve+'</td>'+
							'<td style="text-align:left; margin:1pt;">'+row.nom+'</td>'+
							'<td style="text-align:left; margin:1pt;">'+(row.upd=='1'?'Actualizado':(row.upd=='0'?'nuevo':''))+'</td>'+
						'</tr>';
					}
					else{
						HTML+=
						'<tr style="text-align:left; margin:5pt; color:#EEEEEE; border: solid 2pt #995555; background-color:#993333">'+
							'<td style="text-align:left; margin:1pt;">'+row.row+'</td>'+
							'<td style="text-align:left; margin:1pt;" colspan="3">'+row.msg+'</td>'+
						'</tr>';
					}
				}
			} catch(ex) { }
			
			$('#tbody_result_id').html(HTML);
			//closeTimer();
 	    },
 	    error: function(msg){ },
		complete: function(msg){
			$('#div_img_loading_id').hide();
			$('#div_btns_id').show();
			closeTimer();
		},
 	});
}

function uploadFile(runOnSuccess){
	
	var fd = new FormData();    
	var file = $("input[type='file']")[0].files[0];
	fd.append("userfile", file);
	
	var fileName = file.name;
	var fileSize = file.size;
	
	$('#div_img_loading_id').show();
	
	$.ajax({
		type: 'POST',
		url: 'ImportColaboradores',
		data: fd,
		processData: false,
		contentType: false,
		success: function(msg){
			
			var data = jQuery.parseJSON(msg);
			
			if(runOnSuccess != null && typeof runOnSuccess=='function')
				runOnSuccess(data.file);
			
			resetTimer();
		}
	});
	
	
}

function consultaSectores(){
	var usuario = $("#usuario").val();
	var idsectorU = $("#idsectorU").val();
	$('#div_sec_id').hide();
	$('#img_loading_sec_id').show();
	
	$.ajax({
		type: 'GET',
		url: 'ImportColaboradores',
		data: 'view=consultaSectores&usuario='+usuario+'&idsectorU='+idsectorU,
		success: function(msg){
			if (msg.indexOf('<option') >= 0)
				$('#select_sector_id').html(msg);
			else
				$('#select_sector_id').html('');
		},
		complete: function(msg){
			$('#div_sec_id').show();
			$('#img_loading_sec_id').hide();
			$('#div_nic_id').show();
		}
	});
}



function consultaNichos(){
	var idsector = $('#select_sector_id').val();
	if (idsector=='S'){
		$('#select_nicho_id').html('');
		return;
	}
	$('#div_nic_id').hide();
	$('#img_loading_nic_id').show();
	
	$.ajax({
		type: 'GET',
		url: 'ImportColaboradores',
		data: 'view=consultaNichos&idsector='+idsector,
		success: function(msg){
			if (msg.indexOf('<option') >= 0){
				$('#select_nicho_id').html(msg);
			}
			else
				$('#select_nicho_id').html('');
			
		},
		complete: function(msg) {
			$('#div_nic_id').show();
			$('#img_loading_nic_id').hide();
		}
	});
}



//___________________________________________________________________________
var timerProgressBar=null;
//var timerProgressBar_event=null;
function resetTimer(){
	closeTimer();
	timerProgressBar = setInterval(timerProgressBar_Tick, 2000);
}
function closeTimer(){
	if(timerProgressBar!=null){
		clearTimeout(timerProgressBar);
		timerProgressBar=null;
	}
}
function timerProgressBar_Tick(){
	
	closeTimer();
	$.ajax({
		type: 'GET',
		url: 'ProgressBar',
		//data: 'view=ProgressBar',
		complete: function(msg){
			resetTimer();
		},
		success: function(msg)
		{
			if(msg != null && msg.length<5){
				$('#div_porcentaje_id').html(msg+" %");
				$('#progressbar_loading').val(msg);
				
				if(msg=='100'){
					if (console)
						console.log('finish');
				}
				else
					resetTimer();
			}
		},
		error: function(msg){
			resetTimer();
		}
	});
}
// ___________________________________________________________________________

