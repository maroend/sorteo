/*
App Sorteo Anáhuac
Version: 1.0
Author: Jose Carlos Ruiz Garcia
Website: http://www.redanahuac.mx/app/sorteo
*/


var pag = 1;

var Listar = function() {
	"use strict";
	return {
		init : function() {
			handleListar();
		}
	}
}()

$(function() {
	$('#alerta').hide();
	$(window).load(function() {
		Listar.init();
	});
});


function onkeyup_colfield_check(e) {
	var enterKey = 13;
	if (e.which == enterKey) {
		pag=1;
		handleListar()
	}
}

function changeShow() {
	pag=1;
	handleListar()
}

function getPag(page) {
	pag = page;
	handleListar();
}

var handleListar = function() {

	var show = $("#data-elements-length").val();
	var search = $("#searchtable").val();

	divBlock('Buscando...');

	$.ajax({
		type: "GET",
		cache: false,
		url: "Sectores",
		data: "view=Buscar&pg="+pag+"&show="+show+"&search="+btoa(search),
		success: function(msg){
			
			$('div.block').unblock();
			$("#listresultados").html(msg);
		}
	});
}



//SECCION AGREGAR




function divBlock(msg) {
	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
		overlayCSS: {backgroundColor: '#FFF'},
		message: '<img src="assets/img/load-search.gif" /><br><h2> '+msg+' </h2>'
	});
}

// TODO - Insertar
function Insertar(){

	//$('#alerta').hide();

	if( $('#formulario').parsley().validate() ){
		
		save("INSERT", function(msg)
		{
			var data = jQuery.parseJSON(msg);

			$('html, body').animate({scrollTop:0}, 10);

			if(data.result=='OK'){
				$('#idsector').val("");
				$('#sector').val("");
				$('#clave').val("");
				$('#descripcion').val("");
			}
			
			if (data.msg!=''){
				if (data.result == 'OK')
					$.gritter.add({ title: 'CORRECTO', text: data.msg });
				else
					$.gritter.add({ title: 'ERROR !', text: data.msg });
				
			}
			Listar.init();
		});
	}
	return false;
}

function BuscarEditar(idsector){


	divBlock('Buscando...');

	$.ajax({
		type: "GET",
		cache: false,
		url: "Sectores",
		data: "view=BuscarEditar&idsector="+idsector,
		success: function(msg){
			
			$("#btnSubmit").text('Guardar cambios');
			$("#btnSubmit").attr("onClick", "javascript:Actualizar('"+idsector+"');return false;");

			var contenido = msg.split('#%#');

			$('#idsector').val(contenido[0]);
			$('#sector').val(contenido[1]);
			$('#clave').val(contenido[2]);
			$('#descripcion').val(contenido[3]);
			
			$('#clave').prop('disabled', true);
			//$('#clave').hide();
			//$('#span_clave').show();
			
			$('#formulario').parsley().validate();
			$('html, body').animate({scrollTop:0}, 10);
		},
		complete: function() {
			$('div.block').unblock();
		},
	});
}



function save(action, onsuccess)
{
	var idsector = $('#idsector').val();
	var clave = $('#clave').val();
	var sector = $('#sector').val();
	var descripcion = $('#descripcion').val();

	divBlock("Guardando...");
	
	$.ajax({
		type: "POST",
		cache: false,
		url: "Sectores",
		data: {
			action : action,
			idsector : idsector,
			clave : clave,
			sector : btoa(sector),
			descripcion : btoa(descripcion)
		},
		success: function(msg){
			$('div.block').unblock();
			if (onsuccess!=null && typeof onsuccess == 'function')
				onsuccess(msg);
		},
		error: function() {
			$('div.block').unblock();
		},
		complete: function() {
			//$('#img_aceptar_gif').hide();
		}
	});
}


function Actualizar(idsector){

	if( $('#formulario').parsley().validate())
	{
		save("UPDATE", function(msg)
		{
			$("#btnSubmit").attr("onClick","javascript:Insertar();return false;");
			$("#btnSubmit").text('Agregar');

			$('#clave').prop('disabled', false);

			$('#idsector').val('0');
			$('#sector').val('');
			$('#clave').val('');
			$('#descripcion').val('');

			var data = jQuery.parseJSON(msg);
			
			if (data.msg!=''){
				if (data.result == 'OK')
					$.gritter.add({ title: 'CORRECTO', text: data.msg });
				else
					$.gritter.add({ title: 'ERROR !', text: data.msg });
			}
			Listar.init();

		});
	}
}



function Borrar(idsector) {

	var confirm = window.confirm("Esta seguro de Borrar el Sector?");
	if (confirm == true)
	{
		divBlock("Borrando...");
	
		$.ajax({
			type : "GET",
			cache : false,
			url : "Sectores",
			data : "view=Borrar&idsector=" + idsector,
			success : function(msg) {
				$('div.block').unblock();
				
				var data=jQuery.parseJSON(msg);
				
				if (data.result == 'OK')
					$.gritter.add({ title: "CORRECTO", text: data.msg });
				else
					$.gritter.add({ title: "ERROR !", text: data.msg });

				pag = 1;
				Listar.init();
			},
			error : function(msg) {
				$('div.block').unblock();
				$.gritter.add({ title: "ERROR !", text: msg });
			}
		});
	}
}



function Comision(idsector)
{
	$("#comision").val('');
	$('#formulario2').parsley().reset();
	$("#aceptarmodal").attr("onClick", "javascript:actualizarComision('"+idsector+"');return false;");
	$('#myModal').modal('show');
}

function actualizarComision(idsector){


	var comision = $("#comision").val();

	if( $('#formulario2').parsley().validate() ){

	$('div.block').block({
			css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
			overlayCSS: {backgroundColor: '#FFF'},
			 message: '<img src="assets/img/load-search.gif" /><br><h2> Actualizando Estatus..</h2>'
	});



	/*$.ajax({
		type: "POST",
		url: "Sectores",
		data: { estatus: estatus,idboletos: idboletos,abono: abono},
		success: function(msg){	 */

	$.ajax({
		type: "GET",
		cache: false,
		url: "Sectores",
		data: "view=actualizarComision&idsector="+idsector+"&comision="+comision,
		success: function(msg){

			 $('#myModal').modal('hide');
			 $('div.block').unblock();
			  Listar.init();

			if(msg.trim()==""){



				$.gritter.add({title:"ACTUALIZAR COMISIÓN:",text:"Se ha actualizado con exito!"});



			}else{
						$('html, body').animate({scrollTop:0}, 10);
						$("#alerta").fadeIn();
						$("#alerta").removeClass();
						$("#alerta").addClass("alert alert-error");
						//$("#headAlerta").html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
						$("#bodyAlerta").html("<strong>No te alarmes</strong>!! al parecer no se actualizo, por favor intentalo nuevamente.");


			   }

			 Listar.init();


				}
			   });

   }
  return false;

}



//OBTENER VALORES
jQuery.fn.getCheckboxValues = function(){
	var values = [];
	var i = 0;
	this.each(function(){
		// guarda los valores en un array
		values[i++] = this.id;
	});
	// devuelve un array con los checkboxes seleccionados
	return values;
}



function EliminarSectores() {

	var arr = $("input:checked").getCheckboxValues();
	if (arr[0]=='checkboxall1t')
		arr.shift();

	if (arr.length == 0) {
		alert("Debe elegir un sector");
	} else {
		var procede = confirm("Desea eliminar los sectores marcados?");

		if(procede){
			EliminarArregloSectores(arr);
		}
	}
}



function EliminarArregloSectores(arr)
{
	var idsectores = arr.join();

	divBlock('Eliminando..');

	$.ajax({
		type: "POST",
		cache: false,
		url: "Sectores",
		data: { idsectores: idsectores, action: "DELETE"},
		success: function(msg){
			$('div.block').unblock();
			var data = jQuery.parseJSON(msg);
			
			if (data.result == 'OK')
				$.gritter.add({ title: 'CORRECTO', text: data.msg });
			else
				$.gritter.add({ title: 'ALERTA !', text: data.msg });
			
			Listar.init();
		},
		error: function(msg) {
			$('div.block').unblock();
			alert("Error: "+msg);
		}
	});
}


//SELECCIONAR TODO

function seleccionarTodo(id) {

	if (document.getElementById('checkboxall' + id).checked == 1) {

		for (var i = 0; i < document.forms.namedItem("formulario" + id).elements.length; i++) {
			if (document.forms.namedItem("formulario" + id).elements[i].type == "checkbox") {
				document.forms.namedItem("formulario" + id).elements[i].checked = 1
			}
		}
	} else {

		for (var i = 0; i < document.forms.namedItem("formulario" + id).elements.length; i++)
			if (document.forms.namedItem("formulario" + id).elements[i].type == "checkbox")
				document.forms.namedItem("formulario" + id).elements[i].checked = 0
	}
}



function ExportExcel(){

	var show =	 $("#data-elements-length").val();
	var search =	$("#searchtable").val();


	if(search!=""){ pag=1;}


	location.href="Sectores?view=ExportExcel&pg="+pag+"&show="+show+"&search="+search;

}

