
var numpremio=0;
var global = 'false';
var elem = document.querySelector('.js-switch');
var init = new Switchery(elem);
var handleBootstrapWizards=function(){"use strict";$("#wizard").bwizard()};

var globarow = 0;
var globarowsarray = [];

var FormWizard=function(){"use strict";return{init:function(){
	handleBootstrapWizards();
}}}()


$(function(){
	
	 $('previous').attr('aria-disabled',true);  
	
});//End function jquery




$("#wizard").bwizard({validating:function(e,t){

//	<input type="text" name="numero_premio_id" id="numero_premio_id" value="#NUM_PREMIO#" placeholder="" class="form-control" data-parsley-group="wizard-step-1" required />
	
	if(t.index==0){
		
		
		if(false===$('form[name="form-wizard"]').parsley().validate("wizard-step-2"))
			return false

		handlecontrollersave();
	}
	
}});


	
function processFile(fileName){
	
	globarow = 0;
	
 	$.ajax({ 
 	    type: 'GET',
 	    url: 'ImportSectores',
 	    data: 'view=LoadExcelFile&fileName='+fileName,
 	    success: function(msg){
 	    	
 	    	$('#imgload').hide();
 	    	$('#logtable').show();
 	    	
 	    	
 	    	var HTML = '<tr>  <th>N&#176;</th>  <th>Clave</th>  <th>Sector</th>  <th>Registro</th>  </tr>';
			
			try {
				data=jQuery.parseJSON(msg);

				var acums=data[0];
	 	    	$('#numregistrados').html(acums.records);
	 	    	$('#numwarnings').html(acums.warnings);
	 	    	$('#numerrores').html(acums.errors);
				
				for(var j=1; j<data.length; j++)
				{
					var row=data[j];
					
					var style = row.upd=='1' ? 'background-color:#DDEEDD;' : '';
					if(row.res=='OK'){
						HTML=
						'<tr style="'+style+'">'+
							'<td style="text-align:left; margin:1pt;">'+row.row+'</td>'+
							'<td style="text-align:left; margin:1pt;">'+row.cve+'</td>'+
							'<td style="text-align:left; margin:1pt;">'+row.nom+'</td>'+
							'<td style="text-align:left; margin:1pt;">'+row.des+'</td>'+
							'<td style="text-align:left; margin:1pt;">'+(row.upd=='1'?'Actualizado':(row.upd=='0'?'nuevo':''))+'</td>'+
						'</tr>';
						$('#processfile').append(HTML);
					}
					else{
						HTML=
						'<tr style="text-align:left; margin:5pt; color:#EEEEEE; border: solid 2pt #995555; background-color:#993333">'+
							'<td style="text-align:left; margin:1pt;">'+row.row+'</td>'+
							'<td style="text-align:left; margin:1pt;" colspan="3">'+row.msg+'</td>'+
							'<td style="text-align:left; margin:1pt;">Error</td>'+
						'</tr>';
						$('#processfile').append(HTML);
					}
				}
			} catch(ex) { }
			
			$('#tbody_result_id').html(HTML);
 	    	
 	    	
 	    	
 	    	/*
 	    	
 	    	globarowsarray = [];
 	    	var cadena = response.trim();
 	    	 
 	    	
 	    	globarowsarray = cadena.split('#|#');
 	    	
 	    	var arraytotales = globarowsarray[globarowsarray.length-1].split(',');
 	    	
 	    	$('#numregistrados').html(arraytotales[0]);
 	    	$('#numwarnings').html(arraytotales[1]);
 	    	$('#numerrores').html(arraytotales[2]);
 	    	
 	    	
 	    	 for (var i = 0; i < globarowsarray.length-1; i++) {
 	    		
 	    		 setTimeout(function(){
 	                addElement();
 	            }, 10 * i);
 	        
 	    	 }
 	    	 */
 	    },
		error: function(msg) {
			$('#imgload').html('<h2>Se ha producido un error al intentar leer el archivo</h2>');
			$('#logtable').show();
 	    	$('#logtable').html('<p>Asegurese de que el archivo tenga el formato adecuado (.xls)</p><p><a class="btn btn-primary m-r-5" href="ImportSectores">Regresar</a></p>');
		}
 	});
	
}



function addElement(){
	$('#processfile').append(globarowsarray[globarow]);
	globarow++;
}

var handlecontrollersave = function(){
	
	uploadFile(processFile);
}

function uploadFile(runOnSuccess){
	
	var file_data = $('#inputfileconciliacion').prop('files')[0]; 
	var form_data = new FormData();
	form_data.append('file', file_data);

	$.ajax({
		url : 'ImportSectores',
		dataType : 'text', // what to expect back from the PHP script, if anything
		cache : false,
		contentType : false,
		processData : false,
		data : form_data,
		type : 'post',
		success : function(msg) {
			var data = jQuery.parseJSON(msg);
			if (runOnSuccess!=null && typeof(runOnSuccess)=='function')
				runOnSuccess(data.filename);
		},
		error : function(msg) {
			alert(msg);
		}
	});
	
}

