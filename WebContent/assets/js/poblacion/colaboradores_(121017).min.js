/*
App Sorteo Anáhuac
Version: 1.0
Website: http://www.redanahuac.mx/app/sorteo
*/

var pag = 1;
var asignaciones=[];
var masAsignaciones;
var idcolaborador = '0';
var arrayCheckNichos = [{id:3454, check:false, tals: false}];


var Listar = function () {
	"use strict"; return {
		init: function () {

			handleListar();

		}
	}
}()


$(document).ready(function () {

	$('#alerta').hide();
	buscarSectores();

});


function AgregarColaboradores(idusuario) {

	$('#formulario').parsley().reset();
	$("#formulario")[0].reset();
	$('#clave').val("");
	$('#clave').prop('disabled', false);
	$('#colonia').html("");

	$("#idsector option").prop("selected", false);
	$("#idnicho").html("");
	//$('#descripcion').val("");
	
	$('#referencia').val('0');    // desactivar referencia.
	$('#num_referencia').val('0');
	referencia_click();
	referencia_click();
	
	$('#btn_aceptar_modal').html('Guardar Nuevo');
	$('#btn_aceptar_modal').prop('disabled', false);
	$("#btn_aceptar_modal").attr("onClick", "javascript:Guardar();return false;");
	
	$('#btn_cancelar_modal').prop('disabled', false);
	
	$('#img_aceptar_gif').hide();
	
	$.ajax({
		type: "GET",
		url: "Colaboradores.do",
		data: { "view":"Nuevo" },
		success: function(msg){
			var data=jQuery.parseJSON(msg);
			$('#clave').val(data.clave);
			$('#hidden_comision').val(data.comision);
			buscarSectoresModal();
		},
		error: function() { $('div.block').unblock(); }
	});
	
	
	$('#myModal').modal('show');
	//   $("#listresultados2").html("");
	//   ListarModal.init();
	//   setTimeout("ExisteRoleUsuario("+idusuario+")",900);
}


//SECCION AGREGAR 
function Guardar()
{
	$('#alerta').hide();
	
	var idsector = $('#idsector').val();
	if (idsector == "") {
		alert('Por favor seleccione un sector y un nicho.');
		return false;
	}
	
	if ($('#referencia').val()=='0')
	{
		var num_referencia = $('#num_referencia').val();
		if(num_referencia.trim()=='')
			$('#num_referencia').val('0');
	}

	if ($('#formulario').parsley().validate())
	{
		idcolaborador=0;
		masAsignaciones=false;

		insertar();
	}
	return false;
}

function save(action, onsuccess)
{
	var nichos=[];
	for(var i=0; i<arrayCheckNichos.length; i++) {
		if(arrayCheckNichos[i].check == true)
			nichos.push(arrayCheckNichos[i].sector+';'+arrayCheckNichos[i].id);
	}
	// si no hay nichos marcados y no hay otras asignaciones
	if(nichos.length==0 && masAsignaciones==false){
		alert('Es necesario asignar por lo menos un nicho.');
		return;
	}
	
	$('#btn_aceptar_modal').prop('disabled', true);
	$('#btn_cancelar_modal').prop('disabled', true);
	$('#img_aceptar_gif').show();
	
	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border: "null" },
		overlayCSS: { backgroundColor: '#FFF' },
		message: '<img src="assets/img/load-search.gif" /><br><h2> Guardando...</h2>'
	});
	
	var b64 = btoa(
			"SAVE"
			+ "&" + action
			+ "&idcolaborador=" + idcolaborador
			+ "&clave=" + $('#clave').val()
			+ "&referencia=" + $('#referencia').val()
			+ "&num_referencia=" + $('#num_referencia').val()
			+ "&nombre=" + $('#nombre').val()
			+ "&apaterno=" + $('#apaterno').val()
			+ "&amaterno=" + $('#amaterno').val()
			+ "&comision=" + $('#hidden_comision').val()
			+ "&edad=" + $('#edad').val()
			+ "&rfc=" + $('#rfc').val()
			+ "&telefono_p=" + $('#telefono_p').val()
			+ "&telefono_s=" + $('#telefono_s').val()
			+ "&correo_p=" + $('#correo_p').val()
			+ "&correo_s=" + $('#correo_s').val()
			+ "&cp=" + $('#cp').val()
			+ "&pais=" + $('#pais').val()
			+ "&estado=" + $('#estado').val()
			+ "&mundel=" + $('#mundel').val()
			+ "&colonia=" + $('#colonia').val()
			+ "&calle=" + $('#calle').val()
			+ "&numero_ext=" + $('#numero_ext').val()
			+ "&numero_int=" + $('#numero_int').val()
			+ "&idsector=" + $('#idsector').val()
			+ "&nichos=" + nichos.join()
			);
	$.ajax({
		type: "POST",
		url: "Colaboradores.do",
		data: { q: b64 },
		success: onsuccess,
		complete: function() {
			$('div.block').unblock();
			$('#btn_aceptar_modal').prop('disabled', false);
			$('#btn_cancelar_modal').prop('disabled', false);
			$('#img_aceptar_gif').hide();
		}
	});
}

var insertar = function () {
	save("INSERT",
		function(msg)
		{
			//$('div.block').unblock();
			
			data = jQuery.parseJSON(msg);
			
			if (data.result == "OK") {
				$('#myModal').modal('hide');
				$("#alerta").fadeIn();
				$("#alerta").removeClass("alert-error");
				$("#alerta").addClass("alert alert-success");
				$("#headAlerta").removeClass("fa-exclamation-triangle");
				$("#headAlerta").addClass("fa-check");
				$("#bodyAlerta").html("<strong>Correcto !!</strong> Se ha guardado con exito el colaborador");
				
				Listar.init();
			}
			else if (data.result == "ERROR") {
				$('html, body').animate({ scrollTop: 0 }, 10);
				/*
				$("#alerta").fadeIn();
				$("#alerta").removeClass("alert-success");
				$("#alerta").addClass("alert alert-error");
				$("#headAlerta").removeClass("fa-check");
				$("#headAlerta").addClass("fa-exclamation-triangle");
				$("#bodyAlerta").html(data.msg);
				*/
				$.gritter.add({ title: 'ERROR', text: data.msg });
			}

		}
	);
}

var actualizar=function () {
	save("UPDATE",
		function(msg) {
			$('#myModal').modal('hide');
			$('div.block').unblock();
			
			data = jQuery.parseJSON(msg);
			
			if(data.result=="OK"){
				$("#alerta").fadeIn();
				$("#alerta").removeClass("alert-error");
				$("#alerta").addClass("alert alert-success");
				$("#headAlerta").removeClass("fa-exclamation-triangle");
				$("#headAlerta").addClass("fa-check");
				$("#bodyAlerta").html("<strong>Correcto !!</strong> Se ha guardado con exito el colaborador");
				Listar.init();
			}
			else {
				$('html, body').animate({ scrollTop: 0 }, 10);
				$("#alerta").fadeIn();
				$("#alerta").removeClass("alert-success");
				$("#alerta").addClass("alert alert-error");
				$("#headAlerta").removeClass("fa-check");
				$("#headAlerta").addClass("fa-exclamation-triangle");
				$("#bodyAlerta").html(data.msg);
			}
		}
	);
}


function ShowModalEditar(idcolaborador)
{
	$('#formulario').parsley().reset();
	$("#formulario")[0].reset();
	$('#clave').val("");
	//$("#idsector option").prop("selected", false);
	//$("#idnicho option").html("");
	//$('#descripcion').val("");

	BuscarEditar(idcolaborador);
	$('#myModal').modal('show');
}


function BuscarEditar(id) {
	idcolaborador = id;
	$("#idsector").html('');
	$("#divNichos_id").html('');
	$('#clave').prop('disabled', true);

	$('#btn_aceptar_modal').html('Guardar');
	$('#btn_aceptar_modal').prop('disabled', false);
	$("#btn_aceptar_modal").attr("onClick", "javascript:Editar(" + idcolaborador + ");return false;");
	
	$('#btn_cancelar_modal').prop('disabled', false);

	$('#img_aceptar_gif').hide();

	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border: "null" },
		overlayCSS: { backgroundColor: '#FFF' },
		message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	});

	$.ajax({
		type: "GET",
		url: "Colaboradores.do",
		data: "view=BuscarEditar&idcolaborador=" + idcolaborador,
		success: function (msg) {
			var data;
			try{
				data = jQuery.parseJSON(msg);
				
				//COLABORADOR
				$('#idcolaborador').val(data.id);
				$('#clave').val(data.clave); $('#clave').prop('');
				$('#referencia').val(data.referencia);
				$('#num_referencia').val(data.num_referencia);
				referencia_click();
				referencia_click();
				$('#nombre').val(data.nombre);
				$('#apaterno').val(data.apellidop);
				$('#amaterno').val(data.apellidom);
				$('#hidden_comision').val(data.comision);
				$('#rfc').val(data.rfc);
				$('#edad').val(data.edad);
	
				//TELEFONO
				$('#telefono_p').val(data.telefono_p);
				$('#telefono_s').val(data.telefono_s);
	
				//CORREO
				$('#correo_p').val(data.correo_p);
				$('#correo_s').val(data.correo_s);
	
				//DIRECCION
				$('#pais').val(data.pais);
				$('#estado').val(data.estado);
				$('#mundel').val(data.mundel);
				$('#calle').val(data.calle);
				$('#numero_ext').val(data.numero_ext);
				$('#numero_int').val(data.numero_int);
				$('#cp').val(data.cp);
				$('#colonia').html(data.colonias_html);
	
				//arriba
				$('#colonia option:contains("' + data.colonia + '")').prop('selected', true);
			}
			catch(e) {
				$('#myModal').modal('hide');
			}

			asignaciones=data.asignaciones;
			buscarSectoresModal();
		},
		error: function (msg) {
			$('#myModal').modal('hide');
		},
		complete: function(msg) { $('div.block').unblock(); }
	});

}


function Editar(p_idcolaborador) {

	$('#alerta').hide();
	
	if ($('#referencia').val()=='0')
	{
		var num_referencia = $('#num_referencia').val();
		if(num_referencia.trim()=='')
			$('#num_referencia').val('0');
	}

	if ($('#formulario').parsley().validate()) {
		idcolaborador = p_idcolaborador;

		existenMasAsignaciones(function(){
			actualizar();
		});
	}
	return false;
}

function existenMasAsignaciones(f_success){
	var idsector = $('#idsector').val();
	$.ajax({
		type: "GET",
		url: "Colaboradores.do",
		data: {
			"view":"existenMasAsignaciones",
			"idcolaborador":idcolaborador,
			"idsector":idsector,
		},
		success: function (msg)
		{
			var data = jQuery.parseJSON(msg);

			if(data.result == '1')
				masAsignaciones=true;
			else
				masAsignaciones=false;

			if(f_success != null && typeof f_success == 'function')
				f_success();
		}
	});
	
}


function Borrar(idcolaborador) {
	var arr = [idcolaborador];
	EliminarArregloColaboradores(arr);
}


$('#idsector').change(function (e) {

	e.preventDefault();

	buscarNichosModal();

});



function buscarSectoresModal()
{
	var usuario = $("#usuario").val();
	var idsectorU = $("#idsectorU").val();

	$.ajax({
		type: "GET",
		url: "Colaboradores.do",
		data: "view=buscarSectoresModal&idsectorU=" + idsectorU + "&usuario=" + usuario,
		success: function (msg) {

			$("#idsector").html(msg);
			if (asignaciones != null && asignaciones.length > 0)
			{
				$("#idsector option[value=" + asignaciones[0].sector + "]").attr("selected", true);
				buscarNichosModal();
			}
			
		}
	});
}



function buscarNichosModal() {
	var idsector = $('#idsector').val();

	if (idsector != "S") {

		$.ajax({
			type: "GET",
			url: "Colaboradores.do",
			data: {
				"view":"buscarNichosModal",
				"idsector":idsector,
				"idcolaborador":idcolaborador
			},
			success: function (msg) {
				
				$('#divNichos_id').html(msg);
				/*
				$("#idnicho").html(msg);
				$('#idnicho').multiselect({
			        includeSelectAllOption: true
			    });

				if(idsector == asignaciones[0].sector) {
					//$("#idnicho option[value=" + idnicho + "]").attr("selected", true);
				}
				*/
			}

		});
	} else {
		$("#idnicho").html("");
	}
}


function checkButton(index, check) {
	
	if (check==true){
		//$('#btn_nicho_'+index).removeClass('btn-white');
		//$('#btn_nicho_'+index).addClass('btn-inverse');
		$('#icon_nicho_'+index).removeClass('fa-square-o');
		$('#icon_nicho_'+index).addClass('fa-check-square-o');
	}
	else{
		//$('#btn_nicho_'+index).removeClass('btn-inverse');
		//$('#btn_nicho_'+index).addClass('btn-white');
		$('#icon_nicho_'+index).removeClass('fa-check-square-o');
		$('#icon_nicho_'+index).addClass('fa-square-o');
	}
}
function marcarNicho(index) {
	if (arrayCheckNichos[index].check == false || arrayCheckNichos[index].talonarios == true)
		arrayCheckNichos[index].check = true;
	else
		arrayCheckNichos[index].check = false;
	
	checkButton(index, arrayCheckNichos[index].check);
}






function onkeyup_colfield_check(e) {
	var enterKey = 13;
	if (e.which == enterKey) {
		pag = 1;
		handleListar()
	}
}

function changeShow() {
	pag = 1;
	handleListar()
}

function getPag(page) {

	pag = page;
	handleListar()
}



var handleListar = function () {

	var show = $("#data-elements-length").val();
	var search = btoa($("#searchtable").val());

	var idsectorb = $("#idsectorb").val();
	var idnichob = $("#idnichob").val();

	if (search != "") { }

	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border: "null" },
		overlayCSS: { backgroundColor: '#FFF' },
		message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	});


	$.ajax({
		type: "GET",
		url: "Colaboradores.do",
		data: "view=Buscar&pg=" + pag + "&show=" + show + "&search=" + search + "&idsectorb=" + idsectorb + "&idnichob=" + idnichob,
		success: function (msg) {

			$('div.block').unblock();
			$("#listresultados").html(msg);
			
		},
		error: function(msg) {
			$('#listresultados').html(__msg_sin_conexion);
		}
	});
}


//busca sectores al comienzo de cargar la pagina    


function buscarSectores() {

	var usuario = $("#usuario").val();
	var idsectorU = $("#idsectorU").val();

	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border: "null" },
		overlayCSS: { backgroundColor: '#FFF' },
		message: '<img src="assets/img/load-search.gif" /><br><h2> Buscando..</h2>'
	});

	$.ajax({
		type: "GET",
		url: "Colaboradores.do",
		data: "view=buscarSectores&idsectorU=" + idsectorU + "&usuario=" + usuario,
		success: function (msg) {

			$("#idsectorb").html(msg);
			buscarNichos();
			$('div.block').unblock();
		}
	});
}




$('#idsectorb').change(function (e) {
	e.preventDefault();
	pag = 1;
	buscarNichos();
});



$('#idnichob').change(function (e) {
	e.preventDefault();
	pag = 1;
	handleListar();
});




function buscarNichos() {

	var idusuario = $("#usuario").val();
	var idsector = $('#idsectorb').val(); // sector seleccionado
	var idnichoU = $('#idnichoU').val();  // nicho de usuario

	if (idsector != "")
	{
		$.ajax({
			type: "GET",
			url: "Colaboradores.do",
			data: "view=buscarNichos&idsector=" + idsector + "&idusuario=" + idusuario + "&idnichoU=" + idnichoU,
			success: function (msg) {

				$("#idnichob").html(msg);

				handleListar();
			}
		});
	}
	else {
		$("#idnichob").html('<option value="">Todos</option>');
		handleListar();
	}
}



$("#btnbuscardireccion").click(function ()
{
	var cp = $('#cp').val();

	var colonia = $('#colonia').val();
	/*
	$.blockUI({ css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
	        overlayCSS: {backgroundColor: '#FFF'},
                message: '<img src="skins/default/images/spinner-md.gif" /><br><h3> Espere un momento..</h3>'
                });
                */

	$("#preloader").html('<img src="assets/img/load-search.gif" />');

	$.ajax({
		type: "GET",
		url: "Colaboradores.do",
		data: "view=getDireccion&cp=" + cp,
		success: function (msg) {
			
			var data = jQuery.parseJSON(msg);

			$('#cp').val(data.cp);
			$('#pais').val(data.pais);
			$('#estado').val(data.estado);
			$('#mundel').val(data.mundel);
			$('#colonia').html(data.colonias_html);
			
			$('#colonia option:contains("' + colonia + '")').prop('selected', true);
			
			$("#preloader").html('');
		}

	});

});


var referencia_click=function(){
	var referencia = $('#referencia').val();
	if (referencia=='1'){
		//$('#dib_check_ref').html('<i class="fa fa-square-o"></i>');
		$('#referencia_check').removeClass('fa-check-square-o');
		$('#referencia_check').addClass('fa-square-o');
		$('#referencia').val('0');
		$('#column_referencia').hide();
	}
	else {
		//$('#dib_check_ref').html('<i class="fa fa-check-square-o"></i>');
		$('#referencia_check').removeClass('fa-square-o');
		$('#referencia_check').addClass('fa-check-square-o');
		$('#referencia').val('1');
		$('#column_referencia').show();
	}
}


function gup(name) {

	var regexS = "[\\?&]" + name + "=([^&#]*)";
	var regex = new RegExp(regexS);
	var tmpURL = window.location.href;
	var results = regex.exec(tmpURL);
	if (results == null)
		return "";
	else
		return results[1];
}

function getComision(idcolaborador)
{
	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border: "null" },
		overlayCSS: { backgroundColor: '#FFF' },
		message: '<img src="assets/img/load-search.gif" /><br><h2>Leyendo comision</h2>'
	});
	
	$.ajax({
		type: 'GET',
		url: 'Colaboradores.do',
		data: 'view=getComision&idcolaborador=' + idcolaborador,
		success: function (msg) {
			
			data = jQuery.parseJSON(msg);
			$("#comision").val(data.comision);
			$('#formulario2').parsley().reset();
			$("#aceptarmodalComision").attr("onClick", "javascript:actualizarComision('" + idcolaborador + "');return false;");
			$('#myModalComision').modal('show');
			
		},
		complete: function() { $('div.block').unblock(); }
	});
}

function actualizarComision(idcolaborador)
{
	var comision = $("#comision").val();

	if ($('#formulario2').parsley().validate()) {

		$('div.block').block({
			css: { backgroundColor: 'transparent', color: '#336B86', border: "null" },
			overlayCSS: { backgroundColor: '#FFF' },
			message: '<img src="assets/img/load-search.gif" /><br><h2> Actualizando Estatus..</h2>'
		});

		$.ajax({
			type: "GET",
			url: "Colaboradores.do",
			data: "view=actualizarComision&idcolaborador=" + idcolaborador + "&comision=" + comision,
			success: function (msg) {
				$('#myModalComision').modal('hide');
				$('div.block').unblock();
				Listar.init();

				if (msg.trim() == "") {
					$.gritter.add({ title: "ACTUALIZAR COMISIÓN:", text: "Se ha actualizado con exito!" });
				}
				else {
					$('html, body').animate({ scrollTop: 0 }, 10);
					$("#alerta").fadeIn();
					$("#alerta").removeClass();
					$("#alerta").addClass("alert alert-error");
					//$("#headAlerta").html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
					$("#bodyAlerta").html("<strong>No te alarmes</strong>!! al parecer no se actualizo, por favor intentalo nuevamente.");
				}

				Listar.init();
			}
		});
	}
	return false;
}


//OBTENER VALORES
jQuery.fn.getCheckboxValues = function () {
	var values = [];
	var i = 0;
	this.each(function () {
		// guarda los valores en un array
		values[i++] = this.id;
	});
	// devuelve un array con los checkboxes seleccionados
	return values;
}

function EliminarColaboradores() {
	var arr = $("input:checked.colaborador").getCheckboxValues();

	if (arr.length == 0) {
		alert("Debe elegir un colaborador.");
	} else {
		EliminarArregloColaboradores(arr);
	}
}

function EliminarArregloColaboradores(arr) {
	var procede;
	if (arr.length == 1)
		procede = confirm("Confirmar que desea eliminar el colaborador.");
	else
		procede = confirm("Confirmar que desea eliminar los colaboradores marcados.");

	if (procede) {

		$('div.block').block({
			css: { backgroundColor: 'transparent', color: '#336B86', border: "null" },
			overlayCSS: { backgroundColor: '#FFF' },
			message: '<img src="assets/img/load-search.gif" /><br><h2> Borrando...</h2>'
		});

		var b64 = btoa("DELETE=" + arr.join());

		$.ajax({
			type: "POST",
			cache: false,
			url: "Colaboradores.do",
			data: { q: b64 },
			success: function (data) {
				data = jQuery.parseJSON(data);
				if (data.title != null)
					$.gritter.add({ title: data.title, text: data.message });
				//$('div.block').unblock();
				Listar.init();
			},
			error: function (msg) {
				$.gritter.add({ title: "ERROR", text: msg });
			},
			complete: function () { $('div.block').unblock(); }
		});
	}
}


//SELECCIONAR TODO

function seleccionarTodo(id) {

	if (document.getElementById('checkboxall' + id).checked == 1) {

		for (var i = 0; i < document.forms.namedItem("formulario" + id).elements.length; i++) {
			if (document.forms.namedItem("formulario" + id).elements[i].type == "checkbox") {
				document.forms.namedItem("formulario" + id).elements[i].checked = 1
			}
		}
	}
	else {

		for (var i = 0; i < document.forms.namedItem("formulario" + id).elements.length; i++)
			if (document.forms.namedItem("formulario" + id).elements[i].type == "checkbox")
				document.forms.namedItem("formulario" + id).elements[i].checked = 0
	}
}


function VerAsignaciones(id){
	$.ajax({
		type: "GET",
		cache: false,
		url: "Colaboradores.do",
		data: { view: 'VerAsignaciones', idcolaborador: id },
		success: function (msg) {
			/*
			$("#alerta").fadeIn();
			$("#alerta").removeClass();
			$("#alerta").addClass("alert");
			$("#bodyAlerta").html(msg);
			*/
			$.gritter.add({ title: 'Asignaciones', text: msg });
			/*
			data = jQuery.parseJSON(data);
			if (data.title != null)
				
			//$('div.block').unblock();
			Listar.init();
			*/
		},
		error: function (msg) {
			$.gritter.add({ title: "ERROR", text: msg });
		},
	});
	
	
}


function ExportExcel() {

	var show = $("#data-elements-length").val();
	var search = $("#searchtable").val();

	var idsectorb = $("#idsectorb").val();
	var idnichob = $("#idnichob").val();


	if (search != "") { pag = 1; }


	location.href = "Colaboradores.do?view=ExportExcel&pg=" + pag + "&show=" + show + "&search=" + search + "&idsectorb=" + idsectorb + "&idnichob=" + idnichob;

}
