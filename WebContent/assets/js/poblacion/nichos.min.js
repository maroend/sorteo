/*
App Sorteo Anáhuac
Version: 1.0
Author: Jose Carlos Ruiz Garcia
Website: http://www.redanahuac.mx/app/sorteo
*/


var pag = 1;


var Listar=function(){"use strict";return{init:function(){

	handleListar()

}}}()


var buscarSectores=function(){"use strict";return{init:function(){

	handlebuscarSectores();

}}}()


var guardarNicho=function(){"use strict";return{init:function(){

	Insertar();

}}}()



$(function(){

	//handlebuscarSectoresInicio();


	$(window).load(function() {

	});

});//End function jquery


/*$('#idsector').change(function (e) {

	e.preventDefault();

	// if( $('#formulario').parsley().validate() ){

	buscarSectores.init();
//	}
//	return false;


	});*/

function divBlock(msg) {
	$('div.block').block({
		css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
		overlayCSS: {backgroundColor: '#FFF'},
		message: '<img src="assets/img/load-search.gif" /><br><h2> '+msg+' </h2>'
	});
}


var handlebuscarSectores = function(){

	var idsector = $('#idsector').val();
	var sector = $('#sector').val();

	divBlock('Buscando..');

	$.ajax({
		type : "GET",
		cache : false,
		url : "Nichos.do",
		data : "view=BuscarSector&idsector=" + idsector,
		success : function(msg) {

			// llama a buscar sectores se la busqueda

			$('div.block').unblock();

			$("#idsector").html(msg);

		}

	});

}


// SECCION AGREGAR
function Guardar(){

	if( $('#formulario').parsley().validate() ){

		guardarNicho.init();
	}
	return false;

}


function BuscarEditar(idnicho){

	divBlock('Buscando..');

	$.ajax({
		type: "GET",
		cache: false,
		url: "Nichos.do",
		data: "view=BuscarEditar&idnicho="+idnicho,
		success: function(msg){

			$("#guardar").text('Guardar cambios');
			$("#guardar").attr("onClick", "javascript:Actualizar('"+idnicho+"');return false;");

			var contenido = msg.split('#%#');

			$('#idnicho').val(contenido[0]);
			$('#nicho').val(contenido[1]);
			$("#idsector option[value="+ contenido[2] +"]").attr("selected",true);
			$('#clave').val(contenido[3]);
			$('#limiteventa').val(contenido[4]);
			$('#limitedeposito').val(contenido[5]);
			
			$('#clave').prop('disabled', true);
			$('#idsector').prop('disabled', true);
			

			$('#formulario').parsley().validate();
			$('html, body').animate({scrollTop:0}, 10);
		},
		complete: function() {
			$('div.block').unblock();
		},
	});
}





/*
function Editar(idnicho){



	$('#alerta').hide();


	if( $('#formulario').parsley().validate() ){
	
	
	
	
		var clave = $('#clave').val();
		var idsector = $('#idsector').val();
		var nicho = $('#nicho').val();
		var limitedeposito = $('#limitedeposito').val();
		var limiteventa = $('#limiteventa').val();
	
	
	
		$('div.block').block({
			css: { backgroundColor: 'transparent', color: '#336B86', border:"null" },
			overlayCSS: {backgroundColor: '#FFF'},
			message: '<img src="assets/img/load-search.gif" /><br><h2> Editando..</h2>'
	   });
	
	
		$.ajax({
		type: "GET",
		cache: false,
		url: "Nichos.do",
		data: "view=Editar&idnicho="+idnicho+"&nicho="+nicho+"&idsector="+idsector+"&clave="+clave+"&limitedeposito="+limitedeposito+"&limiteventa="+limiteventa,
		success: function(msg){
	
	
	
			$("#guardar").attr("onClick", "javascript:Guardar();return false;");
			$("#guardar").text('Guardar');
	
			$('div.block').unblock();
			Listar.init();
	
	
	
			$("#idsector option").prop("selected", false);
			$('#nicho').val("");
			$('#clave').val("");
			$('#limitedeposito').val("");
			$('#limiteventa').val("");
			$('#idnicho').val("");
	
			if(msg.trim()==""){
	
				$('html, body').animate({scrollTop:0}, 10);
				$("#alerta").fadeIn();
					$("#alerta").removeClass();
					$("#alerta").addClass("alert alert-success");
				// $("#headAlerta").html("¡Correcto!");
					$("#bodyAlerta").html("Se ha editado con exito el nicho");
	
			}else{
	
				$('html, body').animate({scrollTop:0}, 10);
						$("#alerta").fadeIn();
						$("#alerta").removeClass();
					$("#alerta").addClass("alert alert-error");
						//$("#headAlerta").html("<font size=\"3\">¡Ups! ha ocurrido un Error</font>");
						$("#bodyAlerta").html("<strong>No te alarmes</strong>!! al parecer no se edito el nicho correctamente, por favor intentalo editar nuevamente.");
	
	
			}
	
	
	
	
			}
	
		});
	
	}
	return false;


}
*/




function onkeyup_colfield_check(e){
	var enterKey = 13;
	if (e.which == enterKey){
		pag=1;
		handleListar()
	}
}

function changeShow(){
	pag=1;
	handleListar()
}

function getPag(page){

	pag = page;
	handleListar()
}



var handleListar = function() {

	var show = $("#data-elements-length").val();
	var search = $("#searchtable").val();
	var idsectorb = $("#idsectorb").val();


	divBlock('Buscando..');

	$.ajax({
		type: "GET",
		cache: false,
		url: "Nichos.do",
		data: "view=Buscar&pg="+pag+"&show="+show+"&search="+btoa(search)+"&idsectorb="+idsectorb,
		success: function(msg){
			buscarSectores.init();
			$('div.block').unblock();
			$("#listresultados").html(msg);
		},
		error : function(msg){
			$('div.block').unblock();
		}
	});
}

function save(action, onsuccess)
{
	var idsector = $('#idsector').val();
	var idnicho = $('#idnicho').val();
	var clave = $('#clave').val();
	var nicho = $('#nicho').val();
	var limitedeposito = $('#limitedeposito').val();
	var limiteventa = $('#limiteventa').val();

	divBlock('Guardando..');

	$.ajax({
		type: "POST",
		cache: false,
		url: "Nichos.do",
		data : {
			idsector : idsector,
			idnicho : idnicho,
			clave : clave,
			nicho : btoa(nicho),
			limiteventa : limiteventa,
			limitedeposito : limitedeposito,
			action : action
		},
		success: function(msg){
			$('div.block').unblock();
			if (onsuccess!=null && typeof onsuccess == 'function')
				onsuccess(msg);
		},
		error: function() {
			$('div.block').unblock();
		},
		complete: function() {
			//$('#img_aceptar_gif').hide();
		}
	});	
}

function Insertar(){

	if( $('#formulario').parsley().validate() )
	{
		save("INSERT", function(msg)
		{
			var data = jQuery.parseJSON(msg);

			$('html, body').animate({scrollTop:0}, 10);

			if(data.result=='OK'){
				$('#idnicho').val("0");
				$('#clave').val("");
				$('#nicho').val("");
			}
			
			if (data.msg!=''){
				if (data.result == 'OK')
					$.gritter.add({ title: 'CORRECTO', text: data.msg });
				else
					$.gritter.add({ title: 'ERROR !', text: data.msg });
			}
			Listar.init();
		});
	}
	return false;
}

function Actualizar(idnicho){

	if( $('#formulario').parsley().validate())
	{
		save("UPDATE", function(msg)
		{
			$("#guardar").attr("onClick","javascript:Insertar();return false;");
			$("#guardar").text('Agregar');
			
			$('#clave').prop('disabled', false);
			$('#idsector').prop('disabled', false);

			$('#idnicho').val('0');
			$('#clave').val('');
			$('#nicho').val('');

			var data = jQuery.parseJSON(msg);
			
			if (data.msg!=''){
				if (data.result == 'OK')
					$.gritter.add({ title: 'CORRECTO', text: data.msg });
				else
					$.gritter.add({ title: 'ERROR !', text: data.msg });
			}
			Listar.init();

		});
	}
}






	//

function handlebuscarSectoresInicio() {

	var usuario = $("#usuario").val();
	var idsectorU = $("#idsectorU").val();

	divBlock('Buscando..');

	$.ajax({
		type : "GET",
		cache : false,
		url : "Nichos.do",
		data : "view=BuscarSectorInicio&idsectorU=" + idsectorU + "&usuario="
				+ usuario,
		success : function(msg) {

			Listar.init();
			$('div.block').unblock();
			$("#idsectorb").html(msg);

		}

	});

}




$('#idsectorb').change(function (e) {
	e.preventDefault();
	
	pag=1;
	handleListar();
});




  // OBTENER VALORES
jQuery.fn.getCheckboxValues = function() {
	var values = [];
	var i = 0;
	this.each(function() {
		// guarda los valores en un array
		values[i++] = this.id;
	});
	// devuelve un array con los checkboxes seleccionados
	return values;
}

function Borrar(idnicho){

	var confirm=window.confirm("Esta seguro de Borrar el Nicho?");
	if (confirm == true) {
		divBlock('Borrando..');

		$.ajax({
			type: "GET",
			cache: false,
			url: "Nichos.do",
			data: "view=Borrar&idnicho="+idnicho,
			success : function(msg) {
				$('div.block').unblock();
				
				var data=jQuery.parseJSON(msg);
				
				if (data.result == 'OK'){
					pag = 1;
					$.gritter.add({ title: "CORRECTO", text: data.msg });
				}
				else
					$.gritter.add({ title: "ERROR !", text: data.msg });

				Listar.init();
			},
			error : function(msg) {
				$('div.block').unblock();
				$.gritter.add({ title: "ERROR !", text: msg });
			}
		});
	}
}


function EliminarNichos() {

	var arr = $("input:checked").getCheckboxValues();
	if (arr[0]=='checkboxall1t')
		arr.shift();

	if (arr.length == 0) {
		alert("Debe elegir un nicho");
	} else {
		// $('#idsnichos').val(arr);
		var procede = confirm("Desea eliminar los nichos marcados?");

		if (procede) {
			EliminarArregloNichos(arr);
		}
	}
}



function EliminarArregloNichos(arr) {
	var idsnichos = arr.join();

	divBlock('Eliminando..');

	$.ajax({
		type : "POST",
		cache : false,
		url : "Nichos.do",
		data : { idsnichos : idsnichos, action : 'DELETE' },
		success : function(msg) {
			$('div.block').unblock();
			var data = jQuery.parseJSON(msg);
			
			if (data.result == 'OK')
				$.gritter.add({ title: 'CORRECTO', text: data.msg });
			else
				$.gritter.add({ title: 'ALERTA !', text: data.msg });
			
			Listar.init();
		},
		error : function(msg) {
			$('div.block').unblock();
			alert(msg);
		}
	});
}




  //SELECCIONAR TODO

function seleccionarTodo(id){

	if (document.getElementById('checkboxall' + id).checked == 1) {

		for (var i = 0; i < document.forms.namedItem("formulario" + id).elements.length; i++) {
			if (document.forms.namedItem("formulario" + id).elements[i].type == "checkbox") {
				document.forms.namedItem("formulario" + id).elements[i].checked = 1
			}
		}
	} else {

		for (var i = 0; i < document.forms.namedItem("formulario" + id).elements.length; i++)
			if (document.forms.namedItem("formulario" + id).elements[i].type == "checkbox")
				document.forms.namedItem("formulario" + id).elements[i].checked = 0
	}
}



function ExportExcel() {

	var show = $("#data-elements-length").val();
	var search = $("#searchtable").val();

	var idsectorb = $("#idsectorb").val();

	if (search != "") {
		pag = 1;
	}

	location.href = "Nichos.do?view=ExportExcel&pg=" + pag + "&show=" + show + "&search=" + search + "&idsectorb=" + idsectorb;

}




